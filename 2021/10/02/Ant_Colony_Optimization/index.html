<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>Ant Colony Optimization | KYRIOTA</title>
  <meta name="author" content="KYRIOTA">
  
  <meta name="description" content="蚁群优化算法，最直观的一个示例用途是解决TPS（TravelingSealsmanProblem）问题，快速寻找一个可观的解，但需要你调的一手好参">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Ant Colony Optimization"/>
  <meta property="og:site_name" content="KYRIOTA"/>

  
    <meta property="og:image" content=""/>
  

  
  
    <link href="/favicon.ico" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-70812759-1', 'auto');
  ga('send', 'pageview');
</script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?cb5448498d7169c668b07c2b255d62c1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="KYRIOTA" type="application/atom+xml">
</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">Home</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class=""></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class=""></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class=""></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class=""></i>About
			</a>
		  </li>
		  
		  <li>
			<a href="/friends" title="My friends.">
			  <i class=""></i>Friends
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class=""></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> Ant Colony Optimization</h1>
		</div>
	



<div class="row post">
	<!-- cols -->
	
	<div id="top_meta"></div>
	<div class="col-md-9">
	

	<!-- content -->
	<div class="mypage">		
	  		

	  <p>蚁群优化算法，最直观的一个示例用途是解决TPS（TravelingSealsmanProblem）问题，快速寻找一个可观的解，但需要你调的一手好参</p>
<p><img src="/images/ACO_cover.gif"></p>
<span id="more"></span>

<h1 id="Ant-Colony-Optimization"><a href="#Ant-Colony-Optimization" class="headerlink" title="Ant Colony Optimization"></a>Ant Colony Optimization</h1><blockquote>
<p> 蚁群，退火，遗传，三大知名优化算法</p>
</blockquote>
<p>蚁群优化算法，启发在于蚂蚁觅食的行为，即一段时间后蚂蚁能够找到最短的路径到达食物的位置；核心在于对信息素的抽象，蚁群算法之所以能够快速优化，得益于算法已有的成果积累；一句话说明白这个算法，那就是在当前解的基础上去寻找更优解</p>
<p>本文记录一下写这个算法的unity可视化实现过程，但是我还是建议您自己写一遍👼，体验一下令人非常不愉快的调参体验💢；如果你决定自己写一遍，可以在看了<strong>Getting Start</strong>理解算法原理后直接开干，卡住了再来参考一下后面的具体实现方法</p>
<p>之后应该会先去学一些shader相关的内容，以免在很多之后想做的工程中受限</p>
<h2 id="Getting-Start"><a href="#Getting-Start" class="headerlink" title="Getting Start"></a>Getting Start</h2><h3 id="TPS"><a href="#TPS" class="headerlink" title="TPS"></a>TPS</h3><p>旅行商人问题，一句话概括就是</p>
<blockquote>
<p> 找到一条长度最短的线串联起一些固定的点</p>
</blockquote>
<p>假设有n个点，那么将有<code>(n-1)!/2</code>种可能性，如果遍历所有结果，n稍微一大即刻计算不可行，蚁群优化算法的作用就是在短时间内找到一个可观的解，虽然这个解不一定会是最优解，但相对于算法消耗的算力与时间来说性价比高</p>
<h3 id="Process-Outline"><a href="#Process-Outline" class="headerlink" title="Process Outline"></a>Process Outline</h3><p>在用蚁群算法解决TPS问题时，有两个可以提高效率与结果质量的关键，这两个点不易被注意，所以放在开头就说</p>
<ul>
<li>一、将蚂蚁按组统计：不要在一只蚂蚁结束搜索后立即更新数据，而需要等待一定数量的蚂蚁均完成后再更新</li>
<li>二、随机选取每只蚂蚁的起点：多数时候，蚂蚁多绕的路程均来自于蚂蚁在走到最后一个点后返回起点的那一条线段，如果设定每只蚂蚁的起点不变，效率会更低，多次迭代后的结果也还是会产生交叉路线（which is obviously not the best solution）</li>
</ul>
<p>接下来是每轮（每组）蚂蚁跑的基本流程：</p>
<ul>
<li>随机选择起点</li>
<li>用距离与信息素对路径<strong>加权后随机</strong>选择路径</li>
<li>更新已选择过的点，使得蚂蚁不会返回已经到达过的点</li>
<li>当走到最后一个点，直接返回起点</li>
</ul>
<p>一组蚂蚁跑完后更新信息素矩阵</p>
<ul>
<li>对信息素矩阵乘以一个系数使得已有的信息素浓度降低<ul>
<li>根据当前组蚂蚁跑出来的路径距离长度，当前组中路径最短的蚂蚁留下的信息素最多，而路径长的蚂蚁信息素少</li>
</ul>
</li>
</ul>
<h2 id="Process"><a href="#Process" class="headerlink" title="Process"></a>Process</h2><p>由于算法的计算过程比较零碎，就不拿出来说了，在最后会直接放源码，这里主要解释一些参数</p>
<h3 id="Misc"><a href="#Misc" class="headerlink" title="Misc"></a>Misc</h3><p>点之间距离的表格是对称的</p>
<img src="/images/ACO_disGraph.png" style="zoom:50%;" />

<p>为了只读写一个数据，只取表格的一半就够了，然后写一个函数，输入两个点的index，返回对应的表格中路径的index</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="built_in">int</span> <span class="title">GetPathIndex</span>(<span class="params"><span class="built_in">int</span> cur1, <span class="built_in">int</span> cur2</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (cur1 &gt; cur2)&#123;</span><br><span class="line">        <span class="built_in">int</span> tmp = cur1;</span><br><span class="line">        cur1 = cur2;</span><br><span class="line">        cur2 = tmp;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">int</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">1</span>; i &lt;= cur1; i++) index += numPoint - i;</span><br><span class="line">    index += cur2 - cur1 - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> index;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Parameters"><a href="#Parameters" class="headerlink" title="Parameters"></a>Parameters</h3><p>首先需要介绍一下算法涉及的几个重要参数</p>
<h4 id="Ant"><a href="#Ant" class="headerlink" title="Ant"></a>Ant</h4><p><code>numInGroup</code>规定了一个轮次中的蚂蚁数量，一轮中的蚂蚁越少迭代频率越高，蚂蚁越多则在更短路径上留下信息素的可能越大</p>
<blockquote>
<p>Recommended Value：5~25</p>
</blockquote>
<h4 id="Pheromone"><a href="#Pheromone" class="headerlink" title="Pheromone"></a>Pheromone</h4><p>信息素的必要参数有：<strong>最小值，初始值，增量，衰减值</strong>，但我为了防止浓度过高也弄了个最大值</p>
<ul>
<li><p><code>deltaPhe</code>规定了信息素在迭代时的增量</p>
<blockquote>
<p>Recommended Value：10</p>
</blockquote>
</li>
<li><p><code>pheMaxTimes</code>调整了信息素最大值，由于我的最大值还决定了初始值以及后面的一些对算法的tweak，所以我给出的推荐值会比较大，以制造出不同路径的差异性，从而更快地收敛到可观的解</p>
<blockquote>
<p>Recommended Value：25~50</p>
</blockquote>
</li>
<li><p><code>pheDrop</code>即每次寻路后衰减的百分比</p>
  <figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pheromone[i] *= pheDrop;</span><br><span class="line"><span class="keyword">if</span> (pheromone[i] &lt; pheMin) pheromone[i] = pheMin;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Recommended Value：0.7</p>
</blockquote>
</li>
<li><p>其他几个参数为了省事就通过自己估计的公式计算了嗯</p>
  <figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// calculate pheromone parameters</span></span><br><span class="line">pheMax = deltaPhe * pheMaxTimes * numInGroup;</span><br><span class="line">pheInit = pheMax / <span class="number">5</span>;</span><br><span class="line">pheMin = pheInit * Mathf.Pow(pheDrop, <span class="number">5</span>);</span><br></pre></td></tr></table></figure></li>
<li><p><code>emphasizeBest</code>因为在一轮迭代中可能存在没有蚂蚁按照当前最优解行进的情况，从而导致目前已发现的最优解路径上的信息素浓度降低，故需要在每轮迭代中都假设有一定数量的蚂蚁经过了最优路线，此参数就是用于规定这一具体数量</p>
  <figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pheromone[i] += deltaPhe * emphasizeBest;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Recommended Value：15</p>
</blockquote>
</li>
</ul>
<h4 id="Weight"><a href="#Weight" class="headerlink" title="Weight"></a>Weight</h4><p>蚁群优化算法的核心就在于调整每条路径的概率，而概率由下面的公式决定</p>
<img src="/images/ACO_formula.png" alt="ACO_formula" style="zoom: 50%;" />

<p>其中，<code>τ</code>=信息素浓度，<code>η</code>=1/距离，<code>α</code>与<code>β</code>就是俩权重的参数</p>
<p><code>phePow</code>，即<code>α</code></p>
<blockquote>
<p>Recommended Value：3.5</p>
</blockquote>
<p><code>disPow</code>即<code>β</code></p>
<blockquote>
<p>Recommended Value：6</p>
</blockquote>
<h2 id="Improvement"><a href="#Improvement" class="headerlink" title="Improvement"></a>Improvement</h2><h3 id="Crossing"><a href="#Crossing" class="headerlink" title="Crossing"></a>Crossing</h3><p>最开始说过：交叉的路线明显不是最优解</p>
<p><img src="/images/ACO_crossing.png"></p>
<p>但通常在最开始的时候都会出现交叉路线，而且随着点的数目增加，交叉路线被消除的概率逐步减小。所以我每次在看到最优解的图中一直有一个交叉线半天不动时就会非常难受，所以我们需要考虑如何让蚂蚁自动规避交叉</p>
<ul>
<li>在寻路时规避交叉：降低选择到 会与已选择的路径交叉的 点的概率</li>
<li>在强调最优解时规避交叉：不强调交叉路线的最优解，甚至反手将交叉的路线的信息素浓度降低，并提升不交叉线路的信息素浓度来引导</li>
</ul>
<p>应用以上两条，可以使路径快速迭代至一个没有交叉的状态</p>
<h3 id="Small-Angle"><a href="#Small-Angle" class="headerlink" title="Small Angle"></a>Small Angle</h3><p>路线中出现极小的角度也是非常不理想的一件事</p>
<img src="/images/ACO_smallAngle.png" alt="ACO_smallAngle" style="zoom:67%;" />

<p>说实话目前没有什么很好的解决方案，目前我做的也仅仅是不去强化这个路径之类的，但不能快速处理掉这种情形</p>
<h3 id="Annealing"><a href="#Annealing" class="headerlink" title="Annealing"></a>Annealing</h3><p>调参时会发现许多参数需要动态调整，如初期应增加信息素浓度的权重，而后期却需要信息素与距离的平衡下进行优化，否则就容易自闭收敛，停滞不前；再比如初期应使信息素衰减速率较大，以促进收敛，而后期却需要额外的信息素来减少自闭的概率</p>
<p>这些需求与另一优化算法：<strong>模拟退火算法</strong> 相呼应，在此我没有进行这已实现，但若将这两个算法相结合，则肯定能够使得效率与结果质量都得到提升</p>
<h2 id="Source-Code"><a href="#Source-Code" class="headerlink" title="Source Code"></a>Source Code</h2><div class='spoiler collapsed'>
    <div class='spoiler-title'>
        Main
    </div>
    <div class='spoiler-content'>
        <figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AntColonyOpt</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// min angle that the min path can have</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> angleOffset;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> crossTweakForce;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> crossDiv;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> bParticle;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> bDrawLine;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> emphasizeBest;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> numInGroup;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> preTimes;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> disPow;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> weightPow;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> dropPow;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> deltaPhe;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> pheMaxTimes;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> pheDrop;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> numPoint;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> xRange;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> yRange;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> minDis;</span><br><span class="line">    <span class="keyword">public</span> GameObject pointPrefab;</span><br><span class="line">    <span class="keyword">public</span> GameObject particalPrefab;</span><br><span class="line">    [<span class="meta">HideInInspector</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> preTimeLeft;</span><br><span class="line">    [<span class="meta">HideInInspector</span>]</span><br><span class="line">    <span class="keyword">public</span> Vector2[] pPos;</span><br><span class="line">    [<span class="meta">HideInInspector</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span>[] dis;</span><br><span class="line">    [<span class="meta">HideInInspector</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span>[] pheromone;</span><br><span class="line">    [<span class="meta">HideInInspector</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> pheMax;</span><br><span class="line">    [<span class="meta">HideInInspector</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> numPath;</span><br><span class="line">    [<span class="meta">HideInInspector</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> minPathDis;</span><br><span class="line">    [<span class="meta">HideInInspector</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span>[] minPath;</span><br><span class="line">    [<span class="meta">HideInInspector</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> bSpace;</span><br><span class="line">    [<span class="meta">HideInInspector</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> bAuto;</span><br><span class="line">    [<span class="meta">HideInInspector</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> bFirstRound;</span><br><span class="line">    [<span class="meta">HideInInspector</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> pheInit;</span><br><span class="line">    [<span class="meta">HideInInspector</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> pheMin;</span><br><span class="line">    [<span class="meta">HideInInspector</span>]</span><br><span class="line">    <span class="keyword">public</span> NowPath nowPath;</span><br><span class="line">    [<span class="meta">HideInInspector</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> minCrossCnt;</span><br><span class="line">    [<span class="meta">HideInInspector</span>]</span><br><span class="line">    <span class="keyword">public</span> CrossPath crossPath;</span><br><span class="line">    [<span class="meta">HideInInspector</span>]</span><br><span class="line">    <span class="keyword">public</span> LineRenderer lineRenderer;</span><br><span class="line">    [<span class="meta">HideInInspector</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Particle[] particles;</span><br><span class="line">    [<span class="meta">HideInInspector</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> turnCnt;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="built_in">int</span> <span class="title">C2</span>(<span class="params"><span class="built_in">int</span> n</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="built_in">int</span> result = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = n - <span class="number">1</span>; i &gt; <span class="number">0</span>; i --) result += i;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// passing the index of two point</span></span><br><span class="line">    <span class="comment">// return the index of the path connecting them</span></span><br><span class="line">    <span class="function"><span class="built_in">int</span> <span class="title">GetPathIndex</span>(<span class="params"><span class="built_in">int</span> cur1, <span class="built_in">int</span> cur2</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (cur1 &gt; cur2)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">int</span> tmp = cur1;</span><br><span class="line">            cur1 = cur2;</span><br><span class="line">            cur2 = tmp;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">int</span> index = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">1</span>; i &lt;= cur1; i++) index += numPoint - i;</span><br><span class="line">        index += cur2 - cur1 - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> index;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        nowPath = FindObjectOfType&lt;NowPath&gt;();</span><br><span class="line">        crossPath = FindObjectOfType&lt;CrossPath&gt;();</span><br><span class="line">        <span class="comment">//numPath = (int)C(numPoint, 2);</span></span><br><span class="line">        numPath = C2(numPoint);</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; numPath &amp;&amp; bParticle; i ++)</span><br><span class="line">            Instantiate(particalPrefab);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Start</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        turnCnt = <span class="number">0</span>;</span><br><span class="line">        preTimeLeft = <span class="number">0</span>;</span><br><span class="line">        bAuto = <span class="literal">false</span>;</span><br><span class="line">        bFirstRound = <span class="literal">true</span>;</span><br><span class="line">        pPos = <span class="keyword">new</span> Vector2[numPoint];</span><br><span class="line">        minPath = <span class="keyword">new</span> <span class="built_in">int</span>[numPoint];</span><br><span class="line">        <span class="built_in">float</span> sqrMinDis = minDis * minDis;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// gen random points</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; numPoint; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            minPath[i] = i;</span><br><span class="line"></span><br><span class="line">            Vector2 pos = <span class="keyword">new</span> Vector2(Random.Range(-xRange, xRange), Random.Range(-yRange, yRange));</span><br><span class="line">            <span class="built_in">bool</span> tooClose = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; i; j++)</span><br><span class="line">                <span class="keyword">if</span> ((pos - pPos[j]).sqrMagnitude &lt; sqrMinDis)</span><br><span class="line">                &#123;</span><br><span class="line">                    i--;</span><br><span class="line">                    tooClose = <span class="literal">true</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">if</span> (tooClose) <span class="keyword">continue</span>;</span><br><span class="line">            GameObject point = Instantiate(pointPrefab);</span><br><span class="line">            point.transform.position = pos;</span><br><span class="line">            point.name = i.ToString();</span><br><span class="line">            pPos[i] = pos;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// calculate pheromone parameters</span></span><br><span class="line">        pheMax = deltaPhe * pheMaxTimes * numInGroup;</span><br><span class="line">        pheInit = pheMax / <span class="number">5</span>;</span><br><span class="line">        pheMin = pheInit * Mathf.Pow(pheDrop, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// initialization of arrays</span></span><br><span class="line">        pheromone = <span class="keyword">new</span> <span class="built_in">float</span>[numPath];</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; numPath; i++)</span><br><span class="line">            pheromone[i] = pheInit;</span><br><span class="line">        dis = <span class="keyword">new</span> <span class="built_in">float</span>[numPath];</span><br><span class="line">        particles = FindObjectsOfType&lt;Particle&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// calculate distance</span></span><br><span class="line">        <span class="comment">// set rotation and length of particles</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; numPoint - <span class="number">1</span>; i++)</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> j = i + <span class="number">1</span>; j &lt; numPoint; j++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">int</span> nowIndex = GetPathIndex(i, j);</span><br><span class="line">                dis[nowIndex] = (pPos[j] - pPos[i]).magnitude;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(bParticle)</span><br><span class="line">                &#123;</span><br><span class="line">                    particles[nowIndex].transform.position = pPos[i];</span><br><span class="line"></span><br><span class="line">                    <span class="built_in">float</span> angle = Vector2.Angle(Vector2.up, pPos[j] - pPos[i]);</span><br><span class="line">                    <span class="keyword">if</span> (Vector3.Cross(Vector2.up, pPos[j] - pPos[i]).z &gt; <span class="number">0</span>) angle = -angle;</span><br><span class="line">                    particles[nowIndex].SetParticleRot(angle);</span><br><span class="line"></span><br><span class="line">                    particles[nowIndex].SetParticleDis(dis[nowIndex]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// initialize line renderer</span></span><br><span class="line">        lineRenderer = GetComponent&lt;LineRenderer&gt;();</span><br><span class="line">        lineRenderer.positionCount = numPoint + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Update</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        bSpace = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Input.GetKeyDown(KeyCode.W))</span><br><span class="line">        &#123;</span><br><span class="line">            preTimeLeft = preTimes;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (preTimeLeft &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            preTimeLeft--;</span><br><span class="line">            Opt();</span><br><span class="line">            <span class="keyword">if</span> (preTimeLeft == <span class="number">0</span>) print(<span class="string">&quot;preTimeFinished&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (Input.GetKeyDown(KeyCode.Space))</span><br><span class="line">        &#123;</span><br><span class="line">            bSpace = <span class="literal">true</span>;</span><br><span class="line">            Opt();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (Input.GetKeyDown(KeyCode.S))</span><br><span class="line">        &#123;</span><br><span class="line">            GameObject[] points = GameObject.FindGameObjectsWithTag(<span class="string">&quot;Point&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; numPoint; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                Destroy(points[i]);</span><br><span class="line">                nowPath.ClearPath();</span><br><span class="line">            &#125;</span><br><span class="line">            Start();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (Input.GetKeyDown(KeyCode.A))</span><br><span class="line">        &#123;</span><br><span class="line">            print(<span class="string">&quot;AUTO&quot;</span>);</span><br><span class="line">            bAuto = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (Input.GetKeyDown(KeyCode.D))</span><br><span class="line">        &#123;</span><br><span class="line">            print(<span class="string">&quot;MANUAL&quot;</span>);</span><br><span class="line">            bAuto = <span class="literal">false</span>;</span><br><span class="line">            print(turnCnt);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (bAuto) Opt();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Opt</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        turnCnt++;</span><br><span class="line">        <span class="built_in">int</span>[] path = <span class="keyword">new</span> <span class="built_in">int</span>[numPoint * numInGroup];</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> antCnt = <span class="number">0</span>; antCnt &lt; numInGroup; antCnt++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// offset of starting point index</span></span><br><span class="line">            <span class="built_in">int</span> offset = Random.Range(<span class="number">0</span>, numPoint);</span><br><span class="line">            <span class="built_in">int</span> nowP = offset;</span><br><span class="line">            <span class="built_in">int</span> numVisited = <span class="number">0</span>;</span><br><span class="line">            <span class="built_in">bool</span>[] visited = <span class="keyword">new</span> <span class="built_in">bool</span>[numPoint];</span><br><span class="line">            visited[offset] = <span class="literal">true</span>;</span><br><span class="line">            path[numPoint * antCnt] = offset;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> turn = <span class="number">0</span>; turn &lt; numPoint - <span class="number">1</span>; turn++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">float</span>[] tempDis = <span class="keyword">new</span> <span class="built_in">float</span>[numPoint];</span><br><span class="line">                <span class="built_in">float</span>[] tempPhe = <span class="keyword">new</span> <span class="built_in">float</span>[numPoint];</span><br><span class="line">                <span class="built_in">float</span>[] weight = <span class="keyword">new</span> <span class="built_in">float</span>[numPoint];</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; numPoint; i++)</span><br><span class="line">                    <span class="keyword">if</span> (!visited[i])</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">int</span> nowIndex = GetPathIndex(nowP, i);</span><br><span class="line">                        <span class="built_in">float</span> nowDis = Mathf.Pow(<span class="number">1f</span> / dis[nowIndex], disPow);</span><br><span class="line">                        <span class="comment">// weight will be diveded by total then</span></span><br><span class="line">                        tempPhe[i] = pheromone[nowIndex];</span><br><span class="line">                        tempDis[i] = nowDis;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// calculate weight</span></span><br><span class="line">                <span class="built_in">float</span> totalWeight = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; numPoint; i++)</span><br><span class="line">                    <span class="keyword">if</span> (!visited[i])</span><br><span class="line">                    &#123;</span><br><span class="line">                        weight[i] = Mathf.Pow(tempDis[i] * tempPhe[i], weightPow);</span><br><span class="line">                        <span class="comment">// reduce chance of getting cross</span></span><br><span class="line">                        <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; numVisited - <span class="number">1</span>; j ++)</span><br><span class="line">                            <span class="keyword">if</span>(DetectCross(pPos[i], pPos[nowP], pPos[path[j + numPoint * antCnt]], pPos[path[j + <span class="number">1</span> + numPoint * antCnt]]))</span><br><span class="line">                                weight[i] /= crossDiv;</span><br><span class="line"></span><br><span class="line">                        totalWeight += weight[i];</span><br><span class="line">                    &#125;</span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; numPoint; i++)</span><br><span class="line">                    <span class="keyword">if</span> (!visited[i])</span><br><span class="line">                        weight[i] /= totalWeight;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Random.value returns in range [0,1]</span></span><br><span class="line">                <span class="built_in">float</span> choice = Random.<span class="keyword">value</span>;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">int</span> decideIndex = offset;</span><br><span class="line">                <span class="built_in">int</span> maxCnt = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">while</span> (maxCnt &lt; <span class="number">2</span> * numPoint)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">int</span> judgingIndex = decideIndex % numPoint;</span><br><span class="line">                    choice -= weight[judgingIndex];</span><br><span class="line">                    <span class="keyword">if</span> (choice &lt;= <span class="number">0</span> &amp;&amp; !visited[judgingIndex])</span><br><span class="line">                    &#123;</span><br><span class="line">                        numVisited++;</span><br><span class="line">                        path[numVisited + numPoint * antCnt] = judgingIndex;</span><br><span class="line">                        nowP = judgingIndex;</span><br><span class="line">                        visited[judgingIndex] = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    decideIndex++;</span><br><span class="line">                    maxCnt++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// update when a turn is ending</span></span><br><span class="line">            <span class="keyword">if</span> (antCnt == numInGroup - <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">float</span> localMinPathDis = <span class="built_in">float</span>.MaxValue;</span><br><span class="line">                <span class="built_in">float</span>[] disGroup = <span class="keyword">new</span> <span class="built_in">float</span>[numInGroup];</span><br><span class="line">                <span class="built_in">int</span> localMinIndex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// get localMinPathDis and its index</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">int</span> antIndex = <span class="number">0</span>; antIndex &lt; numInGroup; antIndex++)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; numPoint; i++)</span><br><span class="line">                        disGroup[antIndex] += dis[GetPathIndex(path[i + numPoint * antIndex],</span><br><span class="line">                            (i + <span class="number">1</span>) % numPoint == <span class="number">0</span> ? path[numPoint * antIndex] : path[i + <span class="number">1</span> + numPoint * antIndex])];</span><br><span class="line">                    <span class="keyword">if</span> (disGroup[antIndex] &lt; localMinPathDis)</span><br><span class="line">                    &#123;</span><br><span class="line">                        localMinPathDis = disGroup[antIndex];</span><br><span class="line">                        localMinIndex = antIndex;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="built_in">int</span>[] localMinPath = <span class="keyword">new</span> <span class="built_in">int</span>[numPoint];</span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; numPoint; i++)</span><br><span class="line">                    localMinPath[i] = path[i + localMinIndex * numPoint];</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(bFirstRound)</span><br><span class="line">                &#123;</span><br><span class="line">                    minPathDis = localMinPathDis;</span><br><span class="line">                    minCrossCnt = CountCross(localMinPath);</span><br><span class="line">                    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; numPoint; i++)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">if</span>(bDrawLine) lineRenderer.SetPosition(i, pPos[localMinPath[i]]);</span><br><span class="line">                        minPath[i] = localMinPath[i];</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span>(bDrawLine) lineRenderer.SetPosition(numPoint, pPos[localMinPath[<span class="number">0</span>]]);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// pheromone drop</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; numPath; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    pheromone[i] *= pheDrop;</span><br><span class="line">                    <span class="keyword">if</span> (pheromone[i] &lt; pheMin) pheromone[i] = pheMin;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// add pheromone of the turn</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">int</span> antIndex = <span class="number">0</span>; antIndex &lt; numInGroup; antIndex++)</span><br><span class="line">                    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; numPoint; i++)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">int</span> nowIndex = GetPathIndex(path[i + numPoint * antIndex], (i + <span class="number">1</span>) % numPoint == <span class="number">0</span></span><br><span class="line">                            ? path[numPoint * antIndex] : path[i + <span class="number">1</span> + numPoint * antIndex]);</span><br><span class="line">                        <span class="comment">// shorter path impacts pheromone more</span></span><br><span class="line">                        pheromone[nowIndex] += deltaPhe * Mathf.Pow(localMinPathDis / disGroup[antIndex], dropPow);</span><br><span class="line">                        <span class="keyword">if</span> (pheromone[nowIndex] &gt; pheMax) pheromone[nowIndex] = pheMax;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// emphasize best solution but avoid its crossing parts and small angle</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; numPoint; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">int</span> cur1 = minPath[i];</span><br><span class="line">                    <span class="built_in">int</span> cur2 = (i + <span class="number">1</span>) % numPoint == <span class="number">0</span> ? minPath[<span class="number">0</span>] : minPath[i + <span class="number">1</span>];</span><br><span class="line">                    <span class="built_in">int</span> nowIndex = GetPathIndex(cur1, cur2);</span><br><span class="line">                    pheromone[nowIndex] += deltaPhe * emphasizeBest;</span><br><span class="line">                    <span class="keyword">if</span> (pheromone[nowIndex] &gt; pheMax) pheromone[nowIndex] = pheMax;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// avoid crossing</span></span><br><span class="line">                    <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; i - <span class="number">1</span>; j++)</span><br><span class="line">                        <span class="keyword">if</span> (DetectCross(pPos[cur1], pPos[cur2], pPos[minPath[j]], pPos[minPath[j + <span class="number">1</span>]]))</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="built_in">int</span> anoIndex = GetPathIndex(minPath[j], minPath[j + <span class="number">1</span>]);</span><br><span class="line">                            pheromone[nowIndex] = pheMin;</span><br><span class="line">                            pheromone[anoIndex] = pheMin;</span><br><span class="line"></span><br><span class="line">                            pheromone[GetPathIndex(cur1, minPath[j])] += deltaPhe * crossTweakForce;</span><br><span class="line">                            <span class="keyword">if</span> (pheromone[GetPathIndex(cur1, minPath[j])] &gt; pheMax) pheromone[nowIndex] = pheMax;</span><br><span class="line">                            pheromone[GetPathIndex(cur2, minPath[j + <span class="number">1</span>])] += deltaPhe * crossTweakForce;</span><br><span class="line">                            <span class="keyword">if</span> (pheromone[GetPathIndex(cur2, minPath[j + <span class="number">1</span>])] &gt; pheMax) pheromone[nowIndex] = pheMax;</span><br><span class="line">                        &#125;</span><br><span class="line">                    <span class="comment">// avoid small angle</span></span><br><span class="line">                    <span class="keyword">if</span> (i != <span class="number">0</span> &amp;&amp; DetectSmallAngle(pPos[cur1] - pPos[cur2], pPos[cur1] - pPos[minPath[i - <span class="number">1</span>]], angleOffset))</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">int</span> anoIndex = GetPathIndex(minPath[i - <span class="number">1</span>], cur1);</span><br><span class="line"></span><br><span class="line">                        pheromone[nowIndex] -= deltaPhe * emphasizeBest;</span><br><span class="line">                        pheromone[anoIndex] -= deltaPhe * emphasizeBest;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// set particle size based on pheromone</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; numPoint &amp;&amp; bParticle; i++)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">int</span> mostPheIndex = i + <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="built_in">int</span> j = i + <span class="number">1</span>; j &lt; numPoint; j++)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">int</span> nowIndex = GetPathIndex(i, j);</span><br><span class="line">                        <span class="built_in">float</span> sizeRatio = (pheromone[nowIndex] - pheMin) / (pheMax - pheMin);</span><br><span class="line">                        particles[nowIndex].SetParticleSize(sizeRatio);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                    </span><br><span class="line">                <span class="comment">// update minPathDis and display</span></span><br><span class="line">                <span class="keyword">if</span> (localMinPathDis &lt; minPathDis)</span><br><span class="line">                &#123;</span><br><span class="line">                    minCrossCnt = CountCross(localMinPath);</span><br><span class="line">                    minPathDis = localMinPathDis;</span><br><span class="line">                    print(minPathDis);</span><br><span class="line">                    print(minCrossCnt);</span><br><span class="line">                    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; numPoint; i++)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">if</span>(bDrawLine) lineRenderer.SetPosition(i, pPos[localMinPath[i]]);</span><br><span class="line">                        minPath[i] = localMinPath[i];</span><br><span class="line">                    &#125;</span><br><span class="line">                <span class="keyword">if</span>(bDrawLine) lineRenderer.SetPosition(numPoint, pPos[localMinPath[<span class="number">0</span>]]);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// show Recent Path</span></span><br><span class="line">                <span class="keyword">if</span> (bSpace &amp;&amp; !bParticle) nowPath.DrawNowPath(path, pPos, numPoint, localMinIndex);</span><br><span class="line"></span><br><span class="line">                bFirstRound = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="built_in">int</span> <span class="title">CountCross</span>(<span class="params"><span class="built_in">int</span>[] path</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="built_in">int</span> crossCnt = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">2</span>; i &lt; path.Length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            Vector3 pA = pPos[path[i]];</span><br><span class="line">            Vector3 pB = pPos[i + <span class="number">1</span> == path.Length ? path[<span class="number">0</span>] : path[i + <span class="number">1</span>]];</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; i - <span class="number">1</span>; j++)</span><br><span class="line">            &#123;</span><br><span class="line">                Vector3 pC = pPos[path[j]];</span><br><span class="line">                Vector3 pD = pPos[path[j + <span class="number">1</span>]];</span><br><span class="line">                <span class="keyword">if</span>(DetectCross(pA, pB, pC, pD)) crossCnt++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> crossCnt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="built_in">bool</span> <span class="title">DetectCross</span>(<span class="params">Vector3 pA, Vector3 pB, Vector3 pC, Vector3 pD</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (Vector3.Dot(Vector3.Cross(pA - pD, pC - pD), Vector3.Cross(pB - pD, pC - pD)) &lt; <span class="number">0</span></span><br><span class="line">            &amp;&amp; Vector3.Dot(Vector3.Cross(pC - pB, pA - pB), Vector3.Cross(pD - pB, pA - pB)) &lt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="built_in">bool</span> <span class="title">DetectSmallAngle</span>(<span class="params">Vector2 vec1, Vector2 vec2, <span class="built_in">float</span> angleOffset</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (Vector2.Angle(vec1, vec2) &lt; angleOffset)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    </div>
</div>

<div class='spoiler collapsed'>
    <div class='spoiler-title'>
        Particles
    </div>
    <div class='spoiler-content'>
        <figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Particle</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> sizePow;</span><br><span class="line">    [<span class="meta">HideInInspector</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">new</span> ParticleSystem particleSystem;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">Awake</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        particleSystem = GetComponent&lt;ParticleSystem&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetParticleRot</span>(<span class="params"><span class="built_in">float</span> angle</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> sh = particleSystem.shape;</span><br><span class="line">        sh.enabled = <span class="literal">true</span>;</span><br><span class="line">        sh.shapeType = ParticleSystemShapeType.Rectangle;</span><br><span class="line">        sh.rotation = <span class="keyword">new</span> Vector3(<span class="number">0f</span>, angle, <span class="number">0f</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetParticleDis</span>(<span class="params"><span class="built_in">float</span> dis</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> main = particleSystem.main;</span><br><span class="line">        <span class="built_in">float</span> speed = main.startSpeed.constant;</span><br><span class="line">        main.startLifetime = dis / speed;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// max Size = 2.5, min Size = 0.5</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetParticleSize</span>(<span class="params"><span class="built_in">float</span> sizeRatio</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> main = particleSystem.main;</span><br><span class="line">        sizeRatio = Mathf.Pow(sizeRatio, sizePow);</span><br><span class="line">        <span class="built_in">float</span> size = sizeRatio * <span class="number">2.5f</span>;</span><br><span class="line">        main.startSize = size &gt; <span class="number">0.5f</span>? size : <span class="number">0f</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    </div>
</div>
<link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>	  
	</div>

	<div>
  	<center>
	<div class="pagination">

    
    
    <a href="/2021/11/17/Uncertainty/" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> Prev</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2021/09/23/Unity-ComputeShaderAndBoid/" type="button" class="btn btn-default ">Next<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>

    </center>
	</div>
	
	<!-- comment -->
	
<section id="comment">
    <h2 class="title">Comments</h2>

    
</section>


	</div> <!-- col-md-9/col-md-12 -->
		
	
	<div id="side_meta">
		<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2021-10-02 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/Unity/">Unity<span>3</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
		

	<!-- toc -->
	<div class="meta-widget">
	
	   <a data-toggle="collapse" data-target="#toc"><i class="fa fa-bars"></i></a>
	   <div id="toc" class="toc collapse in">
		   <span class="toc-title">Contents</span>
			<ol class="toc-article"><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#Ant-Colony-Optimization"><span class="toc-article-text">Ant Colony Optimization</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Getting-Start"><span class="toc-article-text">Getting Start</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#TPS"><span class="toc-article-text">TPS</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Process-Outline"><span class="toc-article-text">Process Outline</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Process"><span class="toc-article-text">Process</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Misc"><span class="toc-article-text">Misc</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Parameters"><span class="toc-article-text">Parameters</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Ant"><span class="toc-article-text">Ant</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Pheromone"><span class="toc-article-text">Pheromone</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#Weight"><span class="toc-article-text">Weight</span></a></li></ol></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Improvement"><span class="toc-article-text">Improvement</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Crossing"><span class="toc-article-text">Crossing</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Small-Angle"><span class="toc-article-text">Small Angle</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Annealing"><span class="toc-article-text">Annealing</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Source-Code"><span class="toc-article-text">Source Code</span></a></li></ol></li></ol>
		</div>
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

	</div>
		

</div><!-- row -->



	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2022 KYRIOTA
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a>,<a target="_blank" rel="noopener" href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>,<a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a> and <a href="http://getbootstrap.com/" target="_blank">BOOTSTRA.386</a>. 
     <br> Theme by <a target="_blank" rel="noopener" href="http://github.com/wzpan/hexo-theme-freemind/">Freemind.386</a>.    
</p>
 </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
