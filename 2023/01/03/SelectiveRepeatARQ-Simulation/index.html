<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  
  <title>Selective Repeat ARQ Simulation | KYRIOTA</title>
  <meta name="author" content="KYRIOTA">
  
  <meta name="description" content="My homework in a course about computer network, coded in javascript in order to put it on my blog and give it a HTML UI to show the detailed process.
Just a simple version of selective repeat ARQ, but maybe helpful for you to understand the algorithm further.">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="Selective Repeat ARQ Simulation"/>
  <meta property="og:site_name" content="KYRIOTA"/>

  
    <meta property="og:image" content=""/>
  

  
  
    <link href="/img/icon.ico" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-70812759-1', 'auto');
  ga('send', 'pageview');
</script>



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?cb5448498d7169c668b07c2b255d62c1";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="KYRIOTA" type="application/atom+xml">
</head>

 <body>
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">Home</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the blogs.">
			  <i class=""></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="Sort by categories.">
			  <i class=""></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About Kyriota">
			  <i class=""></i>About
			</a>
		  </li>
		  
		  <li>
			<a href="/html/meme" title="Ingredients that compose me">
			  <i class=""></i>Meme
			</a>
		  </li>
		  
		  <li>
			<a href="/html/academic" title="Academic Home">
			  <i class=""></i>Academic
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe">
			  <i class=""></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> Selective Repeat ARQ Simulation</h1>
		</div>
	



    <div class="row post">
        <!-- cols -->
        
            <div id="top_meta"></div>
            <div class="col-md-9">
                

                            <!-- content -->
                            <div class="mypage">
                                

                                        <p>My homework in a course about computer network, coded in javascript in order to put it on my blog and give it a HTML UI to show the detailed process.</p>
<p>Just a simple version of selective repeat ARQ, but maybe helpful for you to understand the algorithm further.</p>
<p><img src='/images/ARQ_preview.png' style="zoom:40%;" ></p>
<span id="more"></span>
<!--toc-->
<h1 id="Selective-Repeat-ARQ-Simulation"><a href="#Selective-Repeat-ARQ-Simulation" class="headerlink" title="Selective Repeat ARQ Simulation"></a>Selective Repeat ARQ Simulation</h1><p>First of all, you may wanna check the final result of the simulation: <a target="_blank" rel="noopener" href="https://kyriota.com/html/ARQ">Portal to the final result</a></p>
<h2 id="Theory"><a href="#Theory" class="headerlink" title="Theory"></a>Theory</h2><p>To understand how selective repeat ARQ algorithm was implemented in my program, I recommend you understand the algorithm itself first, so that the following content can be much easier to understand.</p>
<blockquote>
<p>I’ll show this algorithm in the following example of two host communicating</p>
</blockquote>
<p><code>Host A</code> and <code>Host B</code> are connected with each other, and <code>A</code> has some data that needs to send to <code>B</code></p>
<h3 id="Framing"><a href="#Framing" class="headerlink" title="Framing"></a>Framing</h3><ul>
<li>Because the data is too long to be sent at one time (just assume so), <code>A</code> slice the data into several pieces, and give those data sequence numbers in order to tell the proper order to combine the data, in case that the datum are not received in original order</li>
<li>Because the message could be corrupted when transferring, the message should contain some verification code related to the message content like CRC (Cyclic Redundancy Check)</li>
<li>Because <code>B</code> only have information in binary, <code>B</code> needs to know where is the start of the message and so does the end. There should be flags wrapping the whole message and the flag never appear in the middle of the message</li>
<li>Because <code>B</code> would like to know the sender of the message in order to do some further communication, the sender information should be contained in the message</li>
<li>Because <code>B</code> maybe not the receiver of the message but only the router to transmit the message, the true receiver information should be contained in the message</li>
</ul>
<p>So far, the message should be something like this:</p>
<center><code>| flag | destination | source | sequence | data | CRC | flag |</code></center>

<p>After such process, the message should be called as <em>frame</em>, which is a unit of communication in data link layer.</p>
<blockquote>
<p>As for how to make flags only appear in the start and the end of a frame:</p>
<p>In my case, flag is 01111110 that occupies one byte of the frame. To deal with such type of flag, since there are six successive ‘1’s in the flag, we can append a ‘0’ every time the content of the frame appears five successive ‘1’s. And in the decoding part, when five successive ‘1’s was found, remove the ‘0’ behind them, so makes the flag only appears in the start and the end of a frame</p>
</blockquote>
<h3 id="Window-amp-Control-Frame"><a href="#Window-amp-Control-Frame" class="headerlink" title="Window &amp; Control Frame"></a>Window &amp; Control Frame</h3><p>But the sequence number could increase to infinite if <code>A</code> keeps sending messages, so sequence number should be limited in a specific range (usually in the range of 2^n, which makes best use of all bits).</p>
<p>However, when sequence numbers are in a specific range, imagine such situation:</p>
<ul>
<li><p><code>A</code> send a frame with sequence <code>X</code> to <code>B</code></p>
</li>
<li><p>frame corrupted when transmitting</p>
</li>
<li><code>B</code> found it corrupted by doing CRC and dropped it</li>
<li><p><code>A</code> keeps sending following frames, and comes with another frame with sequence <code>X</code></p>
</li>
<li><p>Under such situation, <code>B</code> could take this frame and think it the frame that <code>B</code> found corrupted</p>
</li>
</ul>
<p>In order to make the algorithm work properly, control frame and window are introduced. Here’s how these things make <code>A</code> stop sending frames when frames are corrupted:</p>
<ul>
<li><p>With window and ACK (Acknowledge character) frame implemented, pretend sequence number takes 3 bits, and windows size is 3. The following text indicates sequence of sender(L) and receiver(R), contents in brackets indicates frames that are in current window:</p>
<ul>
<li><p>At the beginning:</p>
<center><code>&#123; |0|1|2| &#125; |3|4|5|6|7|0|1|2|3|... => &#123; |?|?|?| &#125;</code></center>
</li>
<li><p><code>A</code> sends frame 0 and starts a timer for frame 0</p>
</li>
<li><p><code>B</code> received it properly</p>
  <center><code>&#123; |0|1|2| &#125; |3|4|5|6|7|0|1|2|3|... => &#123; |0|?|?| &#125;</code></center>
</li>
<li><p>Because frame 0 is in the correct order, <code>B</code> transmits frame 0 to upper layer to do further process and removes frame 0 from its buffer (in order to make the process clearer, the frame 0 is still texted in the buffer), at the same time, <code>B</code> shifts its window forward and sends ACK frame 0 to <code>A</code></p>
  <center><code>&#123; |0|1|2| &#125; |3|4|5|6|7|0|1|2|3|... => |0| &#123; |?|?|?| &#125;</code></center>
</li>
<li><p><code>A</code> received ACK frame 0, so <code>A</code> removes frame 0 from its buffer, stops timer for frame 0, and shifts the window forward</p>
  <center><code>|0| &#123; |1|2|3| &#125; |4|5|6|7|0|1|2|3|... => |0| &#123; |?|?|?| &#125;</code></center>
</li>
<li><p><code>A</code> sends frame 1 and starts a timer for frame 1</p>
</li>
<li><p>frame 1 corrupted when transmitting</p>
</li>
<li><p><code>B</code> received corrupted frame and drops it</p>
</li>
<li><p><code>A</code> sent frame 2, frame3, and <code>B</code> received them properly and sent ACK frame 2, 3 to <code>A</code>. But due to the first element in the window is not received, <code>B</code> could not shift the window</p>
  <center><code>|0| &#123; |1|2|3| &#125; |4|5|6|7|0|1|2|3|... => |0| &#123; |?|2|3| &#125;</code></center>
</li>
<li><p>Also, because the first element in the window didn’t receive an ACK frame, <code>A</code> cannot move the window neither. Because <code>A</code> finished sending mission in the window, <code>A</code> stops sending the next frame, which is frame 4, and waits for <code>B</code> to send ACK frame 1</p>
</li>
<li><p>Timer for frame 1 found frame 1 overtime, so <code>A</code> sends frame 1 again</p>
</li>
<li><p><code>B</code> received it properly</p>
  <center><code>|0| &#123; |1|2|3| &#125; |4|5|6|7|0|1|2|3|... => |0| &#123; |1|2|3| &#125;</code></center>
</li>
<li><p><code>B</code> shifts the window, transmits frame 1, 2, 3 to upper layer, and sends ACK frame 1 to <code>A</code></p>
  <center><code>|0| &#123; |1|2|3| &#125; |4|5|6|7|0|1|2|3|... => |0|1|2|3| &#123; |?|?|?| &#125;</code></center>
</li>
<li><p><code>A</code> removes frame 1, 2, 3 from buffer and shifts the window</p>
  <center><code>|0|1|2|3| &#123; |4|5|6| &#125; |7|0|1|2|3|... => |0|1|2|3| &#123; |?|?|?| &#125;</code></center>
</li>
</ul>
</li>
<li><p>Under such implementation, there is nearly no problems for <code>A</code> and <code>B</code> can communicate with each other. But the overtime machinic seems too time consuming if ever time a frame is corrupted <code>A</code> will wait for a certain period. So we can make <code>B</code> send a NAK (Negative Acknowledgment) frame to make <code>A</code> resend faster (if <code>B</code> can recognize the sender and sequence number of the corrupted frame)</p>
</li>
</ul>
<p>We call ACK frames and NAK frames as control frames, and normal frames that sending data are called data frames</p>
<p>I think you may have a brief knowledge to selective repeat ARQ after my explanation, now I propose following principles to enhance your knowledge:</p>
<ul>
<li>Sender will not shift window until the first frames in the window receives ACK frame</li>
<li>Receiver will not transmit data to upper layer nor shift the window until the frames in the window are received in the right order</li>
<li>Control frames are dropped once confirmed</li>
<li>Every frame has its timer, they are started once the frame is sent or resent</li>
</ul>
<h3 id="Details"><a href="#Details" class="headerlink" title="Details"></a>Details</h3><ul>
<li><p>Notice that the control frames should be sent with the <strong>highest priority</strong>. Imaging the frame sending buffer has a lot of data frames queuing to be sent. If let the control frames queue behind them, they will never get sent due to the window limit.</p>
</li>
<li><p>In order to tell the frame type, it’s better to add a segment in frame. In my program, the frame is coded as following:</p>
  <center><code>|&nbsp; flag&nbsp; | type &nbsp;| destination | source | sequence |&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; data&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; | &nbsp;CRC &nbsp;&nbsp;| &nbsp;flag&nbsp; |</code></center>
  <center><code>| 1 byte | 1 bit | &nbsp;&nbsp;2 bits &nbsp;&nbsp;&nbsp;| 2 bits | &nbsp;4 bits &nbsp;| at least 1 byte | 1 byte | 1 byte |</code></center>

<p>  So the minimal length of the frame is 41 bits. And in order to make timeout a short time to wait, the maximal length shouldn’t be too long. In my program, I set max length to 65 bits, which means the data has max length of 4 bytes. When the data size is bigger than max length, the data is sliced into pieces.</p>
</li>
<li><p>When corruption rate of the channel is rather a big number, the max length of the frame should be shorter in order to avoid resending.</p>
</li>
</ul>
<h3 id="Error-Control"><a href="#Error-Control" class="headerlink" title="Error Control"></a>Error Control</h3><p>In order to deal with flipping bit that may occur in any part of the frame, discuss every possible situation is necessary for robustness of the program</p>
<ul>
<li><p><strong>How receiver’s binary buffer deal with flags</strong></p>
<p>  If everything goes right, the binary buffer should receive: <code>01111110 ... 01111110</code>, then receiver will take it out from the buffer as a frame and delete those bits in buffer</p>
<p>  When the binary buffer receives following stuff: <code>... 01111110</code>, which means flag appears after some data. In such situation. The bin buffer should drop all the data before the flag and wait for following data</p>
<p>  When the binary buffer receives following stuff:<code>01111110 ...(only a few bits)... 01111110</code>, which means the second flag appears before the frame reaches it’s minimal length. The bin buffer should drop all bits before the second flag and wait for following data</p>
</li>
<li><p><strong>Start Flag</strong></p>
<p>  When a bit was flipped in the start flag, receiver cannot recognize a frame anymore, the related frame drops, only waiting for timeout</p>
</li>
<li><p><strong>End Flag</strong></p>
<p>  When a bit was flipped in the end flag, receiver will take the start flag of the next frame as the end flag of the former one, which will break the current frame and the next frame</p>
<p>  However, the receiver can still get the sender address and the sequence of the first frame, so receiver will send NAK frame about the first frame to sender, but directly drop the next frame without sending NAK frame, only waiting for timeout</p>
</li>
<li><p><strong>Destination</strong></p>
<p>  When a bit was flipped in the destination, the receiver could not receive the frame at all, only waiting for timeout</p>
</li>
<li><p><strong>Source</strong></p>
<p>  When a bit was flipped in the source, the receiver will find CRC doesn’t match and may send a NAK frame to a wrong host. If the wrong host happen to have connection to the receiver, it’s also not a big deal since the worst situation is that the wrong host will send a frame to the receiver</p>
</li>
<li><p><strong>Sequence</strong></p>
<p>  When a bit was flipped in the sequence, the receiver will find CRC doesn’t match and send a NAK frame about a wrong frame to the sender. Not a big deal since the worst situation is that the sender will repeat a frame and wait for the flipped frame until timeout</p>
</li>
<li><p><strong>Data</strong></p>
<p>  When a bit was flipped in the sequence, the receiver will find CRC doesn’t match and send a NAK frame to the sender</p>
</li>
<li><p><strong>CRC</strong></p>
<p>  When a bit was flipped in the sequence, the receiver will find CRC doesn’t match and send a NAK frame to the sender</p>
</li>
</ul>
<h2 id="Source"><a href="#Source" class="headerlink" title="Source"></a>Source</h2><p>For <code>ARQ_Simulator.js</code></p>
<div class='spoiler collapsed'>
    <div class='spoiler-title'>
        Utilities
    </div>
    <div class='spoiler-content'>
        <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> START_TIME = <span class="built_in">Date</span>.now();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> FrameSenderStatus = &#123;</span><br><span class="line">    Queuing: <span class="number">0</span>,</span><br><span class="line">    Sending: <span class="number">1</span>,</span><br><span class="line">    WaitingAck: <span class="number">2</span>,</span><br><span class="line">    Timeout: <span class="number">3</span>,</span><br><span class="line">    Acked: <span class="number">4</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> FrameType = &#123;</span><br><span class="line">    Data: <span class="number">0</span>,</span><br><span class="line">    Control: <span class="number">1</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bin2bytes</span>(<span class="params">bin</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (bin.length % <span class="number">8</span> != <span class="number">0</span>) <span class="comment">// Padding 0 to the first byte</span></span><br><span class="line">        bin = <span class="built_in">Array</span>(<span class="number">8</span> - bin.length % <span class="number">8</span>).fill(<span class="number">0</span>).concat(bin);</span><br><span class="line">    <span class="keyword">var</span> bytes = [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; bin.length; i += <span class="number">8</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> byte = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; <span class="number">8</span>; j++) &#123;</span><br><span class="line">            byte = byte &lt;&lt; <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> (i + j &lt; bin.length)</span><br><span class="line">                byte += bin[i + j];</span><br><span class="line">        &#125;</span><br><span class="line">        bytes.push(byte);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bytes;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bytes2bin</span>(<span class="params">bytes</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> (bytes) == <span class="string">&quot;number&quot;</span>)</span><br><span class="line">        bytes = [bytes];</span><br><span class="line">    <span class="keyword">var</span> bin = [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; bytes.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (bytes[i] &gt; <span class="number">255</span> || bytes[i] &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="string">&quot;Byte out of range&quot;</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; <span class="number">8</span>; j++)</span><br><span class="line">            bin.push((bytes[i] &gt;&gt; (<span class="number">7</span> - j % <span class="number">8</span>)) &amp; <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bin;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">str2bytes</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Convert a string to an array of bytes</span></span><br><span class="line">    <span class="comment">// UTF-8 Supported</span></span><br><span class="line">    <span class="keyword">var</span> bytes = [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; str.length; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> charCode = str.charCodeAt(i);</span><br><span class="line">        <span class="keyword">if</span> (charCode &gt; <span class="number">0xFFFF</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="string">&quot;Character out of range&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (charCode &lt; <span class="number">0x80</span>) &#123;</span><br><span class="line">            bytes.push(charCode);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (charCode &lt; <span class="number">0x800</span>) &#123;</span><br><span class="line">            bytes.push(<span class="number">0xC0</span> | (charCode &gt;&gt; <span class="number">6</span>), <span class="number">0x80</span> | (charCode &amp; <span class="number">0x3F</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            bytes.push(<span class="number">0xE0</span> | (charCode &gt;&gt; <span class="number">12</span>), <span class="number">0x80</span> | ((charCode &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x3F</span>), <span class="number">0x80</span> | (charCode &amp; <span class="number">0x3F</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bytes;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bytes2str</span>(<span class="params">bytes</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Convert an array of bytes to a string</span></span><br><span class="line">    <span class="comment">// UTF-8 Supported</span></span><br><span class="line">    <span class="keyword">var</span> str = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; bytes.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (bytes[i] &lt; <span class="number">0x80</span>) &#123;</span><br><span class="line">            str += <span class="built_in">String</span>.fromCharCode(bytes[i]);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bytes[i] &lt; <span class="number">0xE0</span>) &#123;</span><br><span class="line">            str += <span class="built_in">String</span>.fromCharCode(((bytes[i] &amp; <span class="number">0x1F</span>) &lt;&lt; <span class="number">6</span>) | (bytes[i + <span class="number">1</span>] &amp; <span class="number">0x3F</span>));</span><br><span class="line">            i++;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            str += <span class="built_in">String</span>.fromCharCode(((bytes[i] &amp; <span class="number">0x0F</span>) &lt;&lt; <span class="number">12</span>) | ((bytes[i + <span class="number">1</span>] &amp; <span class="number">0x3F</span>) &lt;&lt; <span class="number">6</span>) | (bytes[i + <span class="number">2</span>] &amp; <span class="number">0x3F</span>));</span><br><span class="line">            i += <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">binArray2CubeText</span>(<span class="params">bin</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> str = bin.join(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="comment">// replace 0 with ▢ and 1 with ▩</span></span><br><span class="line">    str = str.replace(<span class="regexp">/0/g</span>, <span class="string">&quot;▢&quot;</span>).replace(<span class="regexp">/1/g</span>, <span class="string">&quot;▩&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">CubeText2binArray</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// replace ▢ with 0 and ▩ with 1 and make it bin array</span></span><br><span class="line">    str = str.replace(<span class="regexp">/▢/g</span>, <span class="string">&quot;0&quot;</span>).replace(<span class="regexp">/▩/g</span>, <span class="string">&quot;1&quot;</span>).replace(<span class="regexp">/ /g</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> bin = [];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; str.length; i++) &#123;</span><br><span class="line">        bin.push(<span class="built_in">parseInt</span>(str[i]));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> bin;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">crc8</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// CRC-8-CCITT</span></span><br><span class="line">    <span class="comment">// data: array of bytes</span></span><br><span class="line">    <span class="keyword">var</span> POLY = <span class="number">0x07</span>,</span><br><span class="line">        INIT = <span class="number">0</span>,</span><br><span class="line">        XOROUT = <span class="number">0x55</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> crc = INIT, i = <span class="number">0</span>; i &lt; data.length; i++) &#123;</span><br><span class="line">        crc = crc ^ data[i];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; <span class="number">8</span>; j++) &#123;</span><br><span class="line">            crc = crc &amp; <span class="number">0x80</span> ? crc &lt;&lt; <span class="number">1</span> ^ POLY : crc &lt;&lt; <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (crc ^ XOROUT) &amp; <span class="number">0xFF</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">BitStuffing</span>(<span class="params">binArr</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> stuffed = [];</span><br><span class="line">    <span class="keyword">var</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; binArr.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (binArr[i] == <span class="number">1</span>) &#123;</span><br><span class="line">            count++;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            count = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        stuffed.push(binArr[i]);</span><br><span class="line">        <span class="keyword">if</span> (count == <span class="number">5</span>) &#123;</span><br><span class="line">            stuffed.push(<span class="number">0</span>);</span><br><span class="line">            count = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> stuffed;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">BitDestuffing</span>(<span class="params">binArr</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> destuffed = [];</span><br><span class="line">    <span class="keyword">var</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; binArr.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (binArr[i] == <span class="number">1</span>) &#123;</span><br><span class="line">            count++;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            count = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        destuffed.push(binArr[i]);</span><br><span class="line">        <span class="keyword">if</span> (count == <span class="number">5</span>) &#123;</span><br><span class="line">            i++;</span><br><span class="line">            count = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> destuffed;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FrameHelper</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="title">CheckFrame</span>(<span class="params">frame</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// Check if the frame is valid</span></span><br><span class="line">        <span class="comment">// frame: binary array</span></span><br><span class="line">        <span class="comment">// return: boolean</span></span><br><span class="line">        <span class="keyword">if</span> (frame.slice(<span class="number">0</span>, <span class="number">8</span>).join(<span class="string">&quot;&quot;</span>) != <span class="string">&quot;01111110&quot;</span> || frame.slice(-<span class="number">8</span>).join(<span class="string">&quot;&quot;</span>) != <span class="string">&quot;01111110&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> payload = BitDestuffing(frame.slice(<span class="number">8</span>, -<span class="number">8</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> crc = payload.slice(-<span class="number">8</span>);</span><br><span class="line">        <span class="keyword">var</span> crcCal = crc8(bin2bytes(payload.slice(<span class="number">0</span>, -<span class="number">8</span>)));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (crcCal != bin2bytes(crc)[<span class="number">0</span>]) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="title">MakeFrame</span>(<span class="params">destination, source, seq, byteData, type = FrameType.Data</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// return: binary array</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (destination &gt; <span class="number">3</span> || destination &lt; <span class="number">0</span> || source &gt; <span class="number">3</span> || source &lt; <span class="number">0</span> || seq &gt; <span class="number">15</span> || seq &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="string">&quot;Invalid destination, source or sequence&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (byteData.length == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="string">&quot;Data cannot be empty&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (type &gt; FrameType.MAX || type &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="string">&quot;Invalid frame type&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> frame = [];</span><br><span class="line">        <span class="keyword">var</span> flag = bytes2bin(<span class="number">0x7E</span>)</span><br><span class="line">        <span class="keyword">var</span> control = [type, (destination &lt;&lt; <span class="number">6</span>) | (source &lt;&lt; <span class="number">4</span>) | seq];</span><br><span class="line">        <span class="keyword">var</span> binData = bytes2bin(byteData);</span><br><span class="line">        <span class="keyword">if</span> (binData.length &lt; <span class="number">8</span>)</span><br><span class="line">            binData = <span class="built_in">Array</span>(<span class="number">8</span> - binData.length).fill(<span class="number">0</span>).concat(binData);</span><br><span class="line">        <span class="keyword">var</span> crc = crc8(control.concat(byteData));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> payload = bytes2bin(control).slice(<span class="number">7</span>).concat(binData).concat(bytes2bin(crc));</span><br><span class="line">        payload = BitStuffing(payload);</span><br><span class="line"></span><br><span class="line">        frame = frame.concat(flag);</span><br><span class="line">        frame = frame.concat(payload);</span><br><span class="line">        frame = frame.concat(flag);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> frame;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="title">MakeFrameFromeText</span>(<span class="params">destination, source, startSeq, text, maxFrameSize</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// return: 2D array, each element is a binary array frame</span></span><br><span class="line">        <span class="keyword">var</span> frames = [];</span><br><span class="line">        <span class="keyword">var</span> data = str2bytes(text);</span><br><span class="line">        <span class="keyword">var</span> seq = startSeq;</span><br><span class="line">        <span class="keyword">var</span> maxDataSize = maxFrameSize - <span class="number">33</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; data.length; i += maxDataSize) &#123;</span><br><span class="line">            <span class="keyword">var</span> frameData = data.slice(i, i + maxDataSize);</span><br><span class="line">            frames.push(FrameHelper.MakeFrame(destination, source, seq, frameData));</span><br><span class="line">            seq = (seq + <span class="number">1</span>) % <span class="number">16</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> frames;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="title">ExtractFrame</span>(<span class="params">frame, checkFrame = <span class="literal">true</span></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// Extract the frame into destination, source, sequence and data</span></span><br><span class="line">        <span class="comment">// frame: binary array</span></span><br><span class="line">        <span class="comment">// return: object &#123;destination, source, sequence, data&#125;</span></span><br><span class="line">        <span class="keyword">if</span> (checkFrame &amp;&amp; !FrameHelper.CheckFrame(frame))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> payload = BitDestuffing(frame.slice(<span class="number">8</span>, -<span class="number">8</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> type = payload[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">var</span> destination = bin2bytes(payload.slice(<span class="number">1</span>, <span class="number">3</span>))[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">var</span> source = bin2bytes(payload.slice(<span class="number">3</span>, <span class="number">5</span>))[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">var</span> sequence = bin2bytes(payload.slice(<span class="number">5</span>, <span class="number">9</span>))[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">var</span> data = bin2bytes(payload.slice(<span class="number">9</span>, -<span class="number">8</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            type: type,</span><br><span class="line">            destination: destination,</span><br><span class="line">            source: source,</span><br><span class="line">            sequence: sequence,</span><br><span class="line">            data: data</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="title">DisplayFrameInText</span>(<span class="params">frame, split = <span class="string">&quot;&lt;br&gt;&quot;</span>, end = <span class="string">&quot;&lt;br&gt;&lt;br&gt;&quot;</span></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// Display the frame in text</span></span><br><span class="line">        <span class="comment">// frame: binary array</span></span><br><span class="line">        <span class="comment">// return: string</span></span><br><span class="line">        <span class="keyword">var</span> frameObj = FrameHelper.ExtractFrame(frame);</span><br><span class="line">        <span class="keyword">if</span> (frameObj == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (frameObj.type == FrameType.Control) &#123;</span><br><span class="line">            <span class="keyword">if</span> (frameObj.data[<span class="number">0</span>] == <span class="number">0x01</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot; x Sequence: &quot;</span> + frameObj.sequence + split + <span class="string">&quot;ACK Frame&quot;</span> + end;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (frameObj.data[<span class="number">0</span>] == <span class="number">0x00</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot; x Sequence: &quot;</span> + frameObj.sequence + split + <span class="string">&quot;NAK Frame&quot;</span> + end;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot; @ Sequence: &quot;</span> + frameObj.sequence + split + <span class="string">&quot; + Data: &quot;</span> + bytes2str(frameObj.data).slice(<span class="number">0</span>, <span class="number">25</span>) + (bytes2str(frameObj.data).length &gt; <span class="number">25</span> ? <span class="string">&quot; ... &quot;</span> : <span class="string">&quot;&quot;</span>) + end;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="title">FrameFinder</span>(<span class="params">buffer, minFrLen</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// Find the first frame in the buffer by searching for the flags</span></span><br><span class="line">        <span class="comment">// buffer: binary array</span></span><br><span class="line">        <span class="comment">// return: &#123;first frame in the buffer, start, end&#125; or null</span></span><br><span class="line">        <span class="keyword">if</span> (buffer.length &lt; minFrLen)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Find the start of the frame</span></span><br><span class="line">        <span class="keyword">var</span> start = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (</span><br><span class="line">            buffer.slice(start, start + <span class="number">8</span>).join(<span class="string">&quot;&quot;</span>) != <span class="string">&quot;01111110&quot;</span> &amp;&amp;</span><br><span class="line">            start + minFrLen &lt; buffer.length</span><br><span class="line">        )</span><br><span class="line">            start++;</span><br><span class="line">        <span class="keyword">if</span> (start + minFrLen &gt; buffer.length || buffer.slice(start, start + <span class="number">8</span>).join(<span class="string">&quot;&quot;</span>) != <span class="string">&quot;01111110&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Find the end of the frame</span></span><br><span class="line">        <span class="keyword">var</span> end = buffer.length;</span><br><span class="line">        <span class="keyword">while</span> (</span><br><span class="line">            buffer.slice(end - <span class="number">8</span>, end).join(<span class="string">&quot;&quot;</span>) != <span class="string">&quot;01111110&quot;</span> &amp;&amp;</span><br><span class="line">            end - minFrLen &gt; start</span><br><span class="line">        )</span><br><span class="line">            end--;</span><br><span class="line">        <span class="keyword">if</span> (end - minFrLen &lt; start || buffer.slice(end - <span class="number">8</span>, end).join(<span class="string">&quot;&quot;</span>) != <span class="string">&quot;01111110&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            frame: buffer.slice(start, end),</span><br><span class="line">            start: start,</span><br><span class="line">            end: end</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    </div>
</div>
<div class='spoiler collapsed'>
    <div class='spoiler-title'>
        Host Class
    </div>
    <div class='spoiler-content'>
        <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Host</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">simulator, id, UpperLayerFunc = () =&gt; &#123; <span class="keyword">return</span>; &#125;</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.sim = simulator;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">        <span class="built_in">this</span>.UpperLayerFunc = UpperLayerFunc;</span><br><span class="line">        <span class="built_in">this</span>.tickFlag = <span class="literal">false</span>;</span><br><span class="line">        <span class="built_in">this</span>.ui = <span class="literal">null</span>;</span><br><span class="line">        <span class="built_in">this</span>.sendingFrame = <span class="literal">false</span>;</span><br><span class="line">        <span class="built_in">this</span>.tickCnt = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.sentBitCnt = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">this</span>.processedBitCnt = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.receiveBinBuffer = []; <span class="comment">// binary array</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.sendWinSeq = <span class="number">0</span>;</span><br><span class="line">        <span class="built_in">this</span>.frameSender = [];</span><br><span class="line">        <span class="comment">// array of &#123;frame, receiverID, binIndex, sequence, feedback, controlFrame, timeout, status&#125;</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.receiveFrameBuffer = <span class="built_in">Array</span>(<span class="built_in">this</span>.sim.para.winLen).fill(<span class="literal">null</span>);</span><br><span class="line">        <span class="built_in">this</span>.receiveWinSeq = <span class="number">0</span>; <span class="comment">// sequence number of the first frame in the receive window</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.sim.hostList.push(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.Ticker = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">this</span>.tickFlag)</span><br><span class="line">                <span class="built_in">this</span>.Tick();</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;Host &quot;</span> + <span class="built_in">this</span>.id + <span class="string">&quot; is still ticking&quot;</span>)</span><br><span class="line">        &#125;, <span class="built_in">this</span>.sim.para.tick);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">Tick</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.tickFlag = <span class="literal">true</span>;</span><br><span class="line">        <span class="built_in">this</span>.SendListener();</span><br><span class="line">        <span class="built_in">this</span>.ReceiveListener();</span><br><span class="line">        <span class="built_in">this</span>.tickCnt++;</span><br><span class="line">        <span class="built_in">this</span>.tickFlag = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">PushToReceiveFrameBuffer</span>(<span class="params">extractedFrame</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// push the extracted frame to the receive frame buffer</span></span><br><span class="line">        <span class="keyword">var</span> sequence = extractedFrame.sequence;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> distance = <span class="built_in">Math</span>.min((<span class="built_in">this</span>.receiveWinSeq - sequence + <span class="built_in">this</span>.sim.para.seq) % <span class="built_in">this</span>.sim.para.seq, (sequence - <span class="built_in">this</span>.receiveWinSeq + <span class="built_in">this</span>.sim.para.seq) % <span class="built_in">this</span>.sim.para.seq);</span><br><span class="line">        <span class="keyword">if</span> (distance == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.receiveFrameBuffer[<span class="number">0</span>] = extractedFrame;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> expected = []</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &lt; <span class="built_in">this</span>.sim.para.winLen; i++)</span><br><span class="line">                expected.push((<span class="built_in">this</span>.receiveWinSeq + i) % <span class="built_in">this</span>.sim.para.seq);</span><br><span class="line">            <span class="keyword">if</span> (expected.indexOf(sequence) == -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;Host &quot;</span> + <span class="built_in">this</span>.id + <span class="string">&quot; repeated frame &quot;</span> + sequence + <span class="string">&quot; as now is already to frame &quot;</span> + <span class="built_in">this</span>.receiveWinSeq);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">this</span>.receiveFrameBuffer[expected.indexOf(sequence) + <span class="number">1</span>] = extractedFrame;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;👉Host &quot;</span> + <span class="built_in">this</span>.id + <span class="string">&quot; Added frame &quot;</span> + sequence + <span class="string">&quot; to receive buffer &quot;</span> + <span class="string">&quot;as &quot;</span> + expected.indexOf(sequence) + <span class="number">1</span>);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="built_in">this</span>.receiveFrameBuffer);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (<span class="built_in">this</span>.receiveFrameBuffer[<span class="number">0</span>] != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.UpperLayerFunc(<span class="built_in">this</span>.receiveFrameBuffer[<span class="number">0</span>].data);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁▁&quot;</span>)</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;👇Host &quot;</span> + <span class="built_in">this</span>.id + <span class="string">&quot; Removed frame &quot;</span> + <span class="built_in">this</span>.receiveWinSeq + <span class="string">&quot; from receive buffer&quot;</span>);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;ASCII: &quot;</span> + bytes2str(<span class="built_in">this</span>.receiveFrameBuffer[<span class="number">0</span>].data));</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔▔&quot;</span>)</span><br><span class="line">            <span class="built_in">this</span>.receiveFrameBuffer.shift();</span><br><span class="line">            <span class="built_in">this</span>.receiveFrameBuffer.push(<span class="literal">null</span>);</span><br><span class="line">            <span class="built_in">this</span>.receiveWinSeq = (<span class="built_in">this</span>.receiveWinSeq + <span class="number">1</span>) % <span class="built_in">this</span>.sim.para.seq;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;👀 Host &quot;</span> + <span class="built_in">this</span>.id + <span class="string">&quot; Now receive window is at &quot;</span> + <span class="built_in">this</span>.receiveWinSeq);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">HandleControlFrame</span>(<span class="params">extractedFrame</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="built_in">this</span>.sim.para.winLen; i++) &#123;</span><br><span class="line">            <span class="keyword">var</span> fs = <span class="built_in">this</span>.frameSender[i];</span><br><span class="line">            <span class="keyword">if</span> (fs == <span class="literal">null</span> || fs.sequence != extractedFrame.sequence)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            fs.timeout = <span class="literal">null</span>;</span><br><span class="line">            fs.feedback = <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (extractedFrame.data[<span class="number">0</span>] == <span class="number">0x01</span>) &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;    👮🟢Host &quot;</span> + <span class="built_in">this</span>.id + <span class="string">&quot; received ACK frame &quot;</span> + extractedFrame.sequence + <span class="string">&quot; from host &quot;</span> + extractedFrame.source);</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">this</span>.ui) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.ui.LogInfo(<span class="string">&quot;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;👮‍🟢 Received ACK frame&quot;</span> + extractedFrame.sequence, <span class="string">&quot;frameSenderBufferLog&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                fs.status = FrameSenderStatus.Acked;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;    👮🔴Host &quot;</span> + <span class="built_in">this</span>.id + <span class="string">&quot; received NAK frame &quot;</span> + extractedFrame.sequence + <span class="string">&quot; from host &quot;</span> + extractedFrame.source);</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.ui) &#123;</span><br><span class="line">                <span class="built_in">this</span>.ui.LogInfo(<span class="string">&quot;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;👮🔴 Received NAK frame &quot;</span> + extractedFrame.sequence, <span class="string">&quot;frameSenderBufferLog&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            fs.binIndex = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">HandleDataFrame</span>(<span class="params">extractedFrame</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// Check if the frame is in the receive window</span></span><br><span class="line">        <span class="keyword">var</span> distance = <span class="built_in">Math</span>.min((<span class="built_in">this</span>.receiveWinSeq - extractedFrame.sequence + <span class="built_in">this</span>.sim.para.seq) % <span class="built_in">this</span>.sim.para.seq, (extractedFrame.sequence - <span class="built_in">this</span>.receiveWinSeq + <span class="built_in">this</span>.sim.para.seq) % <span class="built_in">this</span>.sim.para.seq);</span><br><span class="line">        <span class="keyword">if</span> (distance &gt;= <span class="built_in">this</span>.sim.para.winLen + <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;❌Host &quot;</span> + <span class="built_in">this</span>.id + <span class="string">&quot; received frame &quot;</span> + extractedFrame.sequence + <span class="string">&quot; from host &quot;</span> + extractedFrame.source + <span class="string">&quot; out of window&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Send ACK frame to the source</span></span><br><span class="line">        <span class="keyword">var</span> fbFrame = FrameHelper.MakeFrame(</span><br><span class="line">            extractedFrame.source,</span><br><span class="line">            <span class="built_in">this</span>.id,</span><br><span class="line">            extractedFrame.sequence,</span><br><span class="line">            [<span class="number">0x01</span>],</span><br><span class="line">            FrameType.Control,</span><br><span class="line">        );</span><br><span class="line">        <span class="built_in">this</span>.LoadFrameToSender(fbFrame);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Save the frame to the receive buffer</span></span><br><span class="line">        <span class="built_in">this</span>.PushToReceiveFrameBuffer(extractedFrame);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">HandleCorruptedFrame</span>(<span class="params">extractedFrame</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// check if the sender id is in the host list, if so, send NAK frame to the source</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.sim.FindHostById(extractedFrame.source) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> fbFrame = FrameHelper.MakeFrame(</span><br><span class="line">                extractedFrame.source,</span><br><span class="line">                <span class="built_in">this</span>.id,</span><br><span class="line">                extractedFrame.sequence,</span><br><span class="line">                [<span class="number">0x00</span>],</span><br><span class="line">                FrameType.Control,</span><br><span class="line">            );</span><br><span class="line">            <span class="built_in">this</span>.LoadFrameToSender(fbFrame);</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.ui) &#123;</span><br><span class="line">                <span class="built_in">this</span>.ui.LogInfo(<span class="string">&quot;&amp;nbsp;&amp;nbsp;✋🏻 Sent NAK to &quot;</span> + extractedFrame.source + <span class="string">&quot; about frame &quot;</span> + extractedFrame.sequence, <span class="string">&quot;receiveBinBufferLog&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.ui) &#123;</span><br><span class="line">            <span class="built_in">this</span>.ui.LogInfo(<span class="string">&quot;&amp;nbsp;&amp;nbsp;❌ Source info corrupted, dropped&quot;</span>, <span class="string">&quot;receiveBinBufferLog&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">ReceiveListener</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// Listen to the receive bin buffer, extract frame and push to receive frame buffer</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check if the first 8 bytes are a valid flag</span></span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            <span class="built_in">this</span>.receiveBinBuffer.length &gt;= <span class="number">8</span> &amp;&amp;</span><br><span class="line">            <span class="built_in">this</span>.receiveBinBuffer.slice(<span class="number">0</span>, <span class="number">8</span>).join(<span class="string">&quot;&quot;</span>) != <span class="string">&quot;01111110&quot;</span></span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="comment">// If not, remove the first byte</span></span><br><span class="line">            <span class="built_in">this</span>.receiveBinBuffer.shift();</span><br><span class="line">            <span class="built_in">this</span>.processedBitCnt++;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.receiveBinBuffer.length &lt; <span class="built_in">this</span>.sim.para.minFrLen)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check if there is valid flag at the middle of the buffer</span></span><br><span class="line">        <span class="keyword">if</span> (</span><br><span class="line">            <span class="built_in">this</span>.receiveBinBuffer.length &gt;= <span class="number">40</span> &amp;&amp;</span><br><span class="line">            <span class="built_in">this</span>.receiveBinBuffer.slice(<span class="number">1</span>, <span class="built_in">this</span>.receiveBinBuffer.length - <span class="number">1</span>).join(<span class="string">&quot;&quot;</span>).indexOf(<span class="string">&quot;01111110&quot;</span>) != -<span class="number">1</span></span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="comment">// If yes, remove the bytes before the flag</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.ui) &#123;</span><br><span class="line">                <span class="built_in">this</span>.ui.LogInfo(<span class="string">&quot;♊ Two or more flag in first &quot;</span> + <span class="built_in">this</span>.sim.para.minFrLen + <span class="string">&quot; bits&quot;</span>, <span class="string">&quot;receiveBinBufferLog&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> flagIndex = <span class="built_in">this</span>.receiveBinBuffer.slice(<span class="number">1</span>, <span class="built_in">this</span>.receiveBinBuffer.length - <span class="number">1</span>).join(<span class="string">&quot;&quot;</span>).indexOf(<span class="string">&quot;01111110&quot;</span>);</span><br><span class="line">            <span class="built_in">this</span>.receiveBinBuffer = <span class="built_in">this</span>.receiveBinBuffer.slice(flagIndex);</span><br><span class="line">            <span class="built_in">this</span>.processedBitCnt += flagIndex;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// if there is enough data to extract a frame</span></span><br><span class="line">        <span class="keyword">var</span> fFinder = FrameHelper.FrameFinder(<span class="built_in">this</span>.receiveBinBuffer, <span class="built_in">this</span>.sim.para.minFrLen);</span><br><span class="line">        <span class="keyword">if</span> (!fFinder)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> frame = fFinder.frame;</span><br><span class="line">        <span class="built_in">this</span>.receiveBinBuffer = <span class="built_in">this</span>.receiveBinBuffer.slice(fFinder.end);</span><br><span class="line">        <span class="built_in">this</span>.processedBitCnt += fFinder.end;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Extract the frame</span></span><br><span class="line">        <span class="keyword">if</span> (FrameHelper.CheckFrame(frame)) &#123; <span class="comment">// if the frame is valid</span></span><br><span class="line">            <span class="keyword">var</span> extractedFrame = FrameHelper.ExtractFrame(frame);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (extractedFrame.destination != <span class="built_in">this</span>.id) &#123;</span><br><span class="line">                <span class="built_in">console</span>.warn(<span class="string">&quot;[DESTINATION] Host &quot;</span> + <span class="built_in">this</span>.id + <span class="string">&quot; received frame for host &quot;</span> + extractedFrame.destination);</span><br><span class="line">                <span class="built_in">console</span>.warn(<span class="string">&quot;[DESTINATION] frame: &quot;</span>, frame);</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">this</span>.ui) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.ui.LogInfo(<span class="string">&quot;🤷‍♂️ Not frame for this host, dropped&quot;</span>, <span class="string">&quot;receiveBinBufferLog&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (extractedFrame.type == FrameType.Control) &#123;</span><br><span class="line">                <span class="comment">// If it&#x27;s a ACK or NAK frame, check frame sender and update the buffer</span></span><br><span class="line">                <span class="comment">// This also shows the host is the sender in this conversation</span></span><br><span class="line">                <span class="built_in">this</span>.HandleControlFrame(extractedFrame);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.HandleDataFrame(extractedFrame);</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">this</span>.ui) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.ui.LogInfo(<span class="string">&quot;📧 Valid data frame &quot;</span> + extractedFrame.sequence + <span class="string">&quot; found, sent it to Frame Receive Buffer&quot;</span>, <span class="string">&quot;receiveBinBufferLog&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// if the frame is corrupted, try to extract and send NAK</span></span><br><span class="line">            <span class="built_in">console</span>.warn(<span class="string">&quot;[CORRUPTED] Host &quot;</span> + <span class="built_in">this</span>.id + <span class="string">&quot; received corrupted frame&quot;</span>);</span><br><span class="line">            <span class="built_in">console</span>.warn(<span class="string">&quot;[CORRUPTED] frame: &quot;</span>, frame);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.ui) &#123;</span><br><span class="line">                <span class="built_in">this</span>.ui.LogInfo(<span class="string">&quot;❓ Corrupted frame received, trying to handle&quot;</span>, <span class="string">&quot;receiveBinBufferLog&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> extractedFrame = FrameHelper.ExtractFrame(frame, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (extractedFrame.destination != <span class="built_in">this</span>.id) &#123;</span><br><span class="line">                <span class="built_in">console</span>.warn(<span class="string">&quot;[DESTINATION] Host &quot;</span> + <span class="built_in">this</span>.id + <span class="string">&quot; received frame for host &quot;</span> + extractedFrame.destination);</span><br><span class="line">                <span class="built_in">console</span>.warn(<span class="string">&quot;[DESTINATION] frame: &quot;</span>, frame);</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">this</span>.ui) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.ui.LogInfo(<span class="string">&quot;🤷‍♂️ Not frame for this host, dropped&quot;</span>, <span class="string">&quot;receiveBinBufferLog&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">this</span>.HandleCorruptedFrame(extractedFrame);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">LoadFrameToSender</span>(<span class="params">frame</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> extractedFrame = FrameHelper.ExtractFrame(frame);</span><br><span class="line">        <span class="built_in">this</span>.frameSender.push(&#123;</span><br><span class="line">            frame: frame.slice(),</span><br><span class="line">            receiverID: extractedFrame.destination,</span><br><span class="line">            binIndex: <span class="number">0</span>,</span><br><span class="line">            sequence: extractedFrame.sequence,</span><br><span class="line">            feedback: <span class="literal">false</span>,</span><br><span class="line">            controlFrame: extractedFrame.type == FrameType.Control,</span><br><span class="line">            timeout: <span class="literal">null</span>, <span class="comment">// timeout = null means the frame is not sent yet</span></span><br><span class="line">            status: FrameSenderStatus.Queuing,</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">SendListener</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// Listen to the send frame buffer, send the frame to the destination using Selective Repeat ARQ protocol</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.frameSender.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// when not sending frame, check if there is any control frame, if so, make the first control frame found the top of the buffer</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="built_in">this</span>.frameSender.length &amp;&amp; !<span class="built_in">this</span>.sendingFrame; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.frameSender[i].controlFrame == <span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;👆👆👆Contorl frame has moved to the top of the buffer&quot;</span>)</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">this</span>.ui) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.ui.LogInfo(<span class="string">&quot;👆👆👆 Contorl frame has moved to the top of the buffer&quot;</span>, <span class="string">&quot;frameSenderBufferLog&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">this</span>.frameSender.unshift(<span class="built_in">this</span>.frameSender.splice(i, <span class="number">1</span>)[<span class="number">0</span>]);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (</span><br><span class="line">            <span class="built_in">this</span>.frameSender.length &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">            <span class="built_in">this</span>.frameSender[<span class="number">0</span>].status == FrameSenderStatus.Acked</span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;      🚮 Host &quot;</span> + <span class="built_in">this</span>.id + <span class="string">&quot; Removed frame &quot;</span> + <span class="built_in">this</span>.frameSender[<span class="number">0</span>].sequence + <span class="string">&quot; from sender buffer&quot;</span>);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;👀 Host &quot;</span> + <span class="built_in">this</span>.id + <span class="string">&quot; Now the send window is at &quot;</span> + <span class="built_in">this</span>.frameSender[<span class="number">0</span>].sequence)</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.ui) &#123;</span><br><span class="line">                <span class="built_in">this</span>.ui.LogInfo(<span class="string">&quot;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;🚮 Removed frame &quot;</span> + <span class="built_in">this</span>.frameSender[<span class="number">0</span>].sequence, <span class="string">&quot;frameSenderBufferLog&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">this</span>.frameSender.shift();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Find the frame that is being sending or frist frame waiting to be sent</span></span><br><span class="line">        <span class="keyword">var</span> currentFrameIndex = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="built_in">this</span>.sim.para.winLen &amp;&amp; i &lt; <span class="built_in">this</span>.frameSender.length; i++) &#123;</span><br><span class="line">            <span class="keyword">var</span> currentFS = <span class="built_in">this</span>.frameSender[i];</span><br><span class="line">            <span class="keyword">if</span> (</span><br><span class="line">                currentFS.timeout == <span class="literal">null</span> &amp;&amp;</span><br><span class="line">                (currentFS.feedback == <span class="literal">false</span> || currentFS.binIndex != currentFS.frame.length)</span><br><span class="line">            ) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!currentFS.feedback) &#123;</span><br><span class="line">                    currentFrameIndex = i;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!<span class="built_in">this</span>.sendingFrame) &#123;</span><br><span class="line">                    currentFrameIndex = i;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (currentFrameIndex == -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// When all frames in the window are sent</span></span><br><span class="line">            <span class="comment">// Check time out in the window range</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="built_in">this</span>.sim.para.winLen &amp;&amp; i &lt; <span class="built_in">this</span>.frameSender.length; i++) &#123;</span><br><span class="line">                <span class="keyword">var</span> currentFS = <span class="built_in">this</span>.frameSender[i];</span><br><span class="line">                <span class="keyword">if</span> (currentFS.timeout != <span class="literal">null</span> &amp;&amp; (<span class="built_in">this</span>.tickCnt &gt; currentFS.timeout)) &#123;</span><br><span class="line">                    <span class="comment">// If time out, reset the frame and send it again</span></span><br><span class="line"></span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">&quot;⏰Host &quot;</span> + <span class="built_in">this</span>.id + <span class="string">&quot; time out frame &quot;</span> + currentFS.sequence + <span class="string">&quot; to host &quot;</span> + currentFS.receiverID);</span><br><span class="line">                    <span class="built_in">console</span>.log(currentFS.timeout)</span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="built_in">this</span>.tickCnt)</span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">this</span>.ui) &#123;</span><br><span class="line">                        <span class="built_in">this</span>.ui.LogInfo(<span class="string">&quot;⏰ Time out frame &quot;</span> + currentFS.sequence, <span class="string">&quot;frameSenderBufferLog&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    currentFS.status = FrameSenderStatus.Timeout;</span><br><span class="line">                    currentFS.binIndex = <span class="number">0</span>;</span><br><span class="line">                    currentFS.timeout = <span class="literal">null</span>;</span><br><span class="line">                    currentFrameIndex = i;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (currentFrameIndex == -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.sendingFrame = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Send a bit of the frame to the destination</span></span><br><span class="line">        <span class="keyword">var</span> destination = <span class="built_in">this</span>.sim.FindHostById(<span class="built_in">this</span>.frameSender[currentFrameIndex].receiverID);</span><br><span class="line">        <span class="keyword">var</span> currentFS = <span class="built_in">this</span>.frameSender[currentFrameIndex];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Update the frameSenderInfo</span></span><br><span class="line">        <span class="keyword">if</span> (currentFS.binIndex != currentFS.frame.length) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (currentFS.binIndex == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.sendingFrame = <span class="literal">true</span>;</span><br><span class="line">                <span class="keyword">var</span> frameContent = bytes2str(FrameHelper.ExtractFrame(currentFS.frame).data);</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;📡Host &quot;</span> + <span class="built_in">this</span>.id + <span class="string">&quot; sending frame:  \&quot;&quot;</span> + frameContent + <span class="string">&quot;\&quot;  to host &quot;</span> + currentFS.receiverID + <span class="string">&quot; (sequence: &quot;</span> + currentFS.sequence);</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">this</span>.ui) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.ui.LogInfo(<span class="string">&quot;📡 Sending frame &quot;</span> + currentFS.sequence + (currentFS.controlFrame ? <span class="string">&quot; (control frame)&quot;</span> : <span class="string">&quot;&quot;</span>), <span class="string">&quot;frameSenderBufferLog&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                currentFS.status = FrameSenderStatus.Sending;</span><br><span class="line">                currentFS.feedback = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            destination.receiveBinBuffer.push(currentFS.frame[currentFS.binIndex])</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> destHost = <span class="built_in">this</span>.sim.hostList[<span class="built_in">this</span>.id == <span class="number">0</span> ? <span class="number">1</span> : <span class="number">0</span>];</span><br><span class="line">            <span class="built_in">this</span>.sentBitCnt++;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// ================================================================================</span></span><br><span class="line">            <span class="comment">// Mannually corrupting the bit randomly</span></span><br><span class="line">            <span class="comment">// ================================================================================</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">Math</span>.random() &lt; <span class="built_in">this</span>.sim.para.corRate) &#123;</span><br><span class="line">                destination.receiveBinBuffer[destination.receiveBinBuffer.length - <span class="number">1</span>] = <span class="number">1</span> - destination.receiveBinBuffer[destination.receiveBinBuffer.length - <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Judge which part of the frame is corrupted</span></span><br><span class="line">                <span class="keyword">if</span> (currentFS.binIndex &lt; <span class="number">8</span>) &#123;</span><br><span class="line">                    <span class="built_in">console</span>.warn(<span class="string">&quot;🔴Host &quot;</span> + <span class="built_in">this</span>.id + <span class="string">&quot; corrupted the header of frame &quot;</span> + currentFS.sequence + <span class="string">&quot; to host &quot;</span> + currentFS.receiverID);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (currentFS.binIndex &lt; <span class="number">9</span>) &#123;</span><br><span class="line">                    <span class="built_in">console</span>.warn(<span class="string">&quot;🔴Host &quot;</span> + <span class="built_in">this</span>.id + <span class="string">&quot; corrupted the type of frame &quot;</span> + currentFS.sequence + <span class="string">&quot; to host &quot;</span> + currentFS.receiverID);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (currentFS.binIndex &lt; <span class="number">11</span>) &#123;</span><br><span class="line">                    <span class="built_in">console</span>.warn(<span class="string">&quot;🔴Host &quot;</span> + <span class="built_in">this</span>.id + <span class="string">&quot; corrupted the destination of frame &quot;</span> + currentFS.sequence + <span class="string">&quot; to host &quot;</span> + currentFS.receiverID);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (currentFS.binIndex &lt; <span class="number">13</span>) &#123;</span><br><span class="line">                    <span class="built_in">console</span>.warn(<span class="string">&quot;🔴Host &quot;</span> + <span class="built_in">this</span>.id + <span class="string">&quot; corrupted the source of frame &quot;</span> + currentFS.sequence + <span class="string">&quot; to host &quot;</span> + currentFS.receiverID);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (currentFS.binIndex &lt; <span class="number">17</span>) &#123;</span><br><span class="line">                    <span class="built_in">console</span>.warn(<span class="string">&quot;🔴Host &quot;</span> + <span class="built_in">this</span>.id + <span class="string">&quot; corrupted the sequence of frame &quot;</span> + currentFS.sequence + <span class="string">&quot; to host &quot;</span> + currentFS.receiverID);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (currentFS.binIndex &lt; currentFS.frame.length - <span class="number">16</span>) &#123;</span><br><span class="line">                    <span class="built_in">console</span>.warn(<span class="string">&quot;🔴Host &quot;</span> + <span class="built_in">this</span>.id + <span class="string">&quot; corrupted the data of frame &quot;</span> + currentFS.sequence + <span class="string">&quot; to host &quot;</span> + currentFS.receiverID);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (currentFS.binIndex &lt; currentFS.frame.length - <span class="number">8</span>) &#123;</span><br><span class="line">                    <span class="built_in">console</span>.warn(<span class="string">&quot;🔴Host &quot;</span> + <span class="built_in">this</span>.id + <span class="string">&quot; corrupted the checksum of frame &quot;</span> + currentFS.sequence + <span class="string">&quot; to host &quot;</span> + currentFS.receiverID);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">console</span>.warn(<span class="string">&quot;🔴Host &quot;</span> + <span class="built_in">this</span>.id + <span class="string">&quot; corrupted the end of frame &quot;</span> + currentFS.sequence + <span class="string">&quot; to host &quot;</span> + currentFS.receiverID);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">var</span> anotherUI = <span class="built_in">this</span>.sim.hostList[<span class="built_in">this</span>.id == <span class="number">0</span> ? <span class="number">1</span> : <span class="number">0</span>].ui;</span><br><span class="line">                <span class="keyword">if</span> (anotherUI) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (currentFS.binIndex &lt; <span class="number">8</span>) &#123;</span><br><span class="line">                        anotherUI.LogInfo(<span class="string">&quot;🔴 Manually corrupted a bit &#123; header &#125; of frame &quot;</span> + currentFS.sequence + (currentFS.controlFrame ? <span class="string">&quot; (control frame)&quot;</span> : <span class="string">&quot;&quot;</span>), <span class="string">&quot;receiveBinBufferLog&quot;</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (currentFS.binIndex &lt; <span class="number">9</span>) &#123;</span><br><span class="line">                        anotherUI.LogInfo(<span class="string">&quot;🔴 Manually corrupted a bit &#123; type &#125; of frame &quot;</span> + currentFS.sequence + (currentFS.controlFrame ? <span class="string">&quot; (control frame)&quot;</span> : <span class="string">&quot;&quot;</span>), <span class="string">&quot;receiveBinBufferLog&quot;</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (currentFS.binIndex &lt; <span class="number">11</span>) &#123;</span><br><span class="line">                        anotherUI.LogInfo(<span class="string">&quot;🔴 Manually corrupted a bit &#123; destination &#125; of frame &quot;</span> + currentFS.sequence + (currentFS.controlFrame ? <span class="string">&quot; (control frame)&quot;</span> : <span class="string">&quot;&quot;</span>), <span class="string">&quot;receiveBinBufferLog&quot;</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (currentFS.binIndex &lt; <span class="number">13</span>) &#123;</span><br><span class="line">                        anotherUI.LogInfo(<span class="string">&quot;🔴 Manually corrupted a bit &#123; source &#125; of frame &quot;</span> + currentFS.sequence + (currentFS.controlFrame ? <span class="string">&quot; (control frame)&quot;</span> : <span class="string">&quot;&quot;</span>), <span class="string">&quot;receiveBinBufferLog&quot;</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (currentFS.binIndex &lt; <span class="number">17</span>) &#123;</span><br><span class="line">                        anotherUI.LogInfo(<span class="string">&quot;🔴 Manually corrupted a bit &#123; sequence &#125; of frame &quot;</span> + currentFS.sequence + (currentFS.controlFrame ? <span class="string">&quot; (control frame)&quot;</span> : <span class="string">&quot;&quot;</span>), <span class="string">&quot;receiveBinBufferLog&quot;</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (currentFS.binIndex &lt; currentFS.frame.length - <span class="number">16</span>) &#123;</span><br><span class="line">                        anotherUI.LogInfo(<span class="string">&quot;🔴 Manually corrupted a bit &#123; data &#125; of frame &quot;</span> + currentFS.sequence + (currentFS.controlFrame ? <span class="string">&quot; (control frame)&quot;</span> : <span class="string">&quot;&quot;</span>), <span class="string">&quot;receiveBinBufferLog&quot;</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (currentFS.binIndex &lt; currentFS.frame.length - <span class="number">8</span>) &#123;</span><br><span class="line">                        anotherUI.LogInfo(<span class="string">&quot;🔴 Manually corrupted a bit &#123; checksum &#125; of frame &quot;</span> + currentFS.sequence + (currentFS.controlFrame ? <span class="string">&quot; (control frame)&quot;</span> : <span class="string">&quot;&quot;</span>), <span class="string">&quot;receiveBinBufferLog&quot;</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        anotherUI.LogInfo(<span class="string">&quot;🔴 Manually corrupted a bit &#123; end &#125; of frame &quot;</span> + currentFS.sequence + (currentFS.controlFrame ? <span class="string">&quot; (control frame)&quot;</span> : <span class="string">&quot;&quot;</span>), <span class="string">&quot;receiveBinBufferLog&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (destHost.ui) &#123;</span><br><span class="line">                    destHost.ui.errorArr.push(<span class="built_in">this</span>.sentBitCnt - <span class="number">1</span>)</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ================================================================================</span></span><br><span class="line"></span><br><span class="line">            currentFS.binIndex++;</span><br><span class="line">            <span class="keyword">if</span> (currentFS.controlFrame == <span class="literal">true</span> &amp;&amp; currentFS.binIndex == currentFS.frame.length) &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;  🔵Host&quot;</span> + <span class="built_in">this</span>.id + <span class="string">&quot; sent control frame &quot;</span> + currentFS.sequence + <span class="string">&quot; to host &quot;</span> + currentFS.receiverID);</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">this</span>.ui) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.ui.LogInfo(<span class="string">&quot;&amp;nbsp;&amp;nbsp;🔵 Sent control frame &quot;</span> + currentFS.sequence, <span class="string">&quot;frameSenderBufferLog&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// remove current frame from the buffer due to it&#x27;s control frame and has been sent</span></span><br><span class="line">                <span class="built_in">this</span>.frameSender.splice(currentFrameIndex, <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">this</span>.sendingFrame = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (currentFS.timeout == <span class="literal">null</span> &amp;&amp; currentFS.feedback == <span class="literal">false</span>) &#123;</span><br><span class="line">                currentFS.timeout = <span class="built_in">this</span>.tickCnt + <span class="built_in">this</span>.sim.para.timeout;</span><br><span class="line">                <span class="comment">// log a message to say that timeout is set</span></span><br><span class="line">                <span class="built_in">console</span>.log(<span class="string">&quot;  ⌚Host &quot;</span> + <span class="built_in">this</span>.id + <span class="string">&quot; timer started for frame &quot;</span> + currentFS.sequence + <span class="string">&quot; to host &quot;</span> + currentFS.receiverID);</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">this</span>.ui) &#123;</span><br><span class="line">                    <span class="built_in">this</span>.ui.LogInfo(<span class="string">&quot;&amp;nbsp;&amp;nbsp;⌚ Timer started for frame &quot;</span> + currentFS.sequence, <span class="string">&quot;frameSenderBufferLog&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                currentFS.status = FrameSenderStatus.WaitingAck;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">SendMessage</span>(<span class="params">message, receiverID</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// Generate frames and add it to the frameSender</span></span><br><span class="line">        <span class="keyword">var</span> frameList = FrameHelper.MakeFrameFromeText(receiverID, <span class="built_in">this</span>.id, <span class="built_in">this</span>.sendWinSeq, message, <span class="built_in">this</span>.sim.para.maxFrLen);</span><br><span class="line">        <span class="built_in">this</span>.sendWinSeq = (<span class="built_in">this</span>.sendWinSeq + frameList.length) % <span class="built_in">this</span>.sim.para.seq;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; frameList.length; i++) &#123;</span><br><span class="line">            <span class="built_in">this</span>.LoadFrameToSender(frameList[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    </div>
</div>
<div class='spoiler collapsed'>
    <div class='spoiler-title'>
        Simulator Class
    </div>
    <div class='spoiler-content'>
        <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Simulator</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">initHostNum, para</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// JS grammar trap: even these parameters have default values, you can&#x27;t use foo(a,c=xxx) to escape parameter b</span></span><br><span class="line">        <span class="comment">// so why don&#x27;t I use &#123;&#125; to wrap the parameters</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.hostList = [];</span><br><span class="line">        <span class="keyword">var</span> timeout = para.timeout;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;Timeout is: &quot;</span> + timeout + <span class="string">&quot;ms according to the tick and frame length&quot;</span>)</span><br><span class="line">        <span class="built_in">this</span>.para = &#123;</span><br><span class="line">            seq: para.seq, <span class="comment">// Squence has 4 bits if SEQ = 16</span></span><br><span class="line">            winLen: para.windowlen, <span class="comment">// Window length</span></span><br><span class="line">            tick: para.tick, <span class="comment">// Tick in milliseconds</span></span><br><span class="line">            minFrLen: para.minFrameLen, <span class="comment">// Minimum frame length</span></span><br><span class="line">            maxFrLen: para.maxFrameLen, <span class="comment">// Maximum frame length</span></span><br><span class="line">            corRate: para.corruptionRate, <span class="comment">// Corruption rate of the channel</span></span><br><span class="line">            timeout: timeout <span class="comment">// Timeout in tick, meaning after how many ticks the sender will resend the frame</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; initHostNum; i++) &#123;</span><br><span class="line">            <span class="keyword">var</span> _ = <span class="keyword">new</span> Host(<span class="built_in">this</span>, i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">FindHostById</span>(<span class="params">id</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="built_in">this</span>.hostList.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.hostList[i].id == id)</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">this</span>.hostList[i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    </div>
</div>
<div class='spoiler collapsed'>
    <div class='spoiler-title'>
        HostUI Class
    </div>
    <div class='spoiler-content'>
        <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HostUI</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="title">constructor</span>(<span class="params">host, simulator</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.host = host;</span><br><span class="line">        <span class="built_in">this</span>.host.ui = <span class="built_in">this</span>;</span><br><span class="line">        <span class="built_in">this</span>.sim = simulator;</span><br><span class="line">        <span class="built_in">this</span>.messageBuffer = [];</span><br><span class="line">        <span class="built_in">this</span>.errorArr = [];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// hostX_userInput, input textare</span></span><br><span class="line">        <span class="built_in">this</span>.userInputUI = <span class="built_in">document</span>.getElementById(<span class="string">&quot;host&quot;</span> + host.id + <span class="string">&quot;_userInput&quot;</span>);</span><br><span class="line">        <span class="comment">// hostX_sendButton, button</span></span><br><span class="line">        <span class="built_in">this</span>.sendButtonUI = <span class="built_in">document</span>.getElementById(<span class="string">&quot;host&quot;</span> + host.id + <span class="string">&quot;_sendButton&quot;</span>);</span><br><span class="line">        <span class="comment">// hostX_frameSenderBuffer, div</span></span><br><span class="line">        <span class="built_in">this</span>.frameSenderUI = <span class="built_in">document</span>.getElementById(<span class="string">&quot;host&quot;</span> + host.id + <span class="string">&quot;_frameSenderBuffer&quot;</span>);</span><br><span class="line">        <span class="comment">// hostX_receiveBinBuffer, div</span></span><br><span class="line">        <span class="built_in">this</span>.receiveBinBufferUI = <span class="built_in">document</span>.getElementById(<span class="string">&quot;host&quot;</span> + host.id + <span class="string">&quot;_receiveBinBuffer&quot;</span>);</span><br><span class="line">        <span class="comment">// hostX_frameReceiverBuffer, div</span></span><br><span class="line">        <span class="built_in">this</span>.frameReceiverUI = <span class="built_in">document</span>.getElementById(<span class="string">&quot;host&quot;</span> + host.id + <span class="string">&quot;_frameReceiverBuffer&quot;</span>);</span><br><span class="line">        <span class="comment">// hostX_message, textarea</span></span><br><span class="line">        <span class="built_in">this</span>.messageUI = <span class="built_in">document</span>.getElementById(<span class="string">&quot;host&quot;</span> + host.id + <span class="string">&quot;_message&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.sendButtonUI.onclick = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.userInputUI.value != <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.host.SendMessage(<span class="built_in">this</span>.userInputUI.value, <span class="built_in">this</span>.host.id == <span class="number">0</span> ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        host.UpperLayerFunc = <span class="built_in">this</span>.ShowInMessageUI.bind(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// set interval to update the UI</span></span><br><span class="line">        <span class="built_in">this</span>.uiTicker = <span class="built_in">setInterval</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.Update();</span><br><span class="line">        &#125;, <span class="built_in">this</span>.sim.para.tick / <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">LogInfo</span>(<span class="params">message, logger</span>)</span> &#123;</span><br><span class="line">        <span class="comment">// log a message to the host_&#123;logger&#125;</span></span><br><span class="line">        <span class="comment">// logger: frameSenderBufferLog, receiveBinBufferLog</span></span><br><span class="line">        <span class="keyword">var</span> logUI = <span class="built_in">document</span>.getElementById(<span class="string">&quot;host&quot;</span> + <span class="built_in">this</span>.host.id + <span class="string">&quot;_&quot;</span> + logger);</span><br><span class="line">        <span class="keyword">if</span> (logUI != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> date = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">            <span class="keyword">var</span> time = date.toLocaleTimeString() + <span class="string">&quot;: &quot;</span>;</span><br><span class="line">            logUI.innerHTML += message + <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">            logUI.scrollTop = logUI.scrollHeight;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">ShowInMessageUI</span>(<span class="params">message</span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.messageUI.value = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">var</span> date = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">        <span class="keyword">var</span> time = date.toLocaleTimeString();</span><br><span class="line">        <span class="built_in">this</span>.messageBuffer.push(&#123; <span class="attr">message</span>: message, <span class="attr">time</span>: time &#125;);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="built_in">this</span>.messageBuffer.length; i++) &#123;</span><br><span class="line">            <span class="built_in">this</span>.messageUI.value += <span class="built_in">this</span>.messageBuffer[i].time + <span class="string">&quot; | &quot;</span> + bytes2str(<span class="built_in">this</span>.messageBuffer[i].message) + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// scroll to the bottom</span></span><br><span class="line">        <span class="built_in">this</span>.messageUI.scrollTop = <span class="built_in">this</span>.messageUI.scrollHeight;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">Update</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.UpdateFrameSenderUI();</span><br><span class="line">        <span class="built_in">this</span>.UpdateReceiveBinBufferUI();</span><br><span class="line">        <span class="built_in">this</span>.UpdateFrameReceiveBufferUI();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">UpdateFrameSenderUI</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.frameSenderUI.innerHTML = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="comment">// remove all child</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="built_in">this</span>.frameSenderUI.firstChild) &#123;</span><br><span class="line">            <span class="built_in">this</span>.frameSenderUI.removeChild(<span class="built_in">this</span>.frameSenderUI.firstChild);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="built_in">this</span>.host.frameSender.length; i++) &#123;</span><br><span class="line">            <span class="keyword">var</span> frSenderInfo = <span class="built_in">this</span>.host.frameSender[i];</span><br><span class="line">            <span class="keyword">var</span> frameUI = <span class="built_in">document</span>.createElement(<span class="string">&quot;div&quot;</span>);</span><br><span class="line">            frameUI.className = <span class="string">&quot;frame&quot;</span>;</span><br><span class="line">            frameUI.innerHTML = FrameHelper.DisplayFrameInText(frSenderInfo.frame);</span><br><span class="line">            <span class="comment">// adjust text size</span></span><br><span class="line">            frameUI.style.fontSize = <span class="number">3</span> + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">            <span class="comment">// adjust text color</span></span><br><span class="line">            <span class="keyword">if</span> (frSenderInfo.status == FrameSenderStatus.Sending) &#123;</span><br><span class="line">                frameUI.style.color = <span class="string">&quot;rgb(51, 204, 255)&quot;</span>; <span class="comment">// blue</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (frSenderInfo.status == FrameSenderStatus.Acked) &#123;</span><br><span class="line">                frameUI.style.color = <span class="string">&quot;rgb(51, 255, 0)&quot;</span>; <span class="comment">// green</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (frSenderInfo.status == FrameSenderStatus.Queuing) &#123;</span><br><span class="line">                frameUI.style.color = <span class="string">&quot;white&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (frSenderInfo.status == FrameSenderStatus.Timeout) &#123;</span><br><span class="line">                frameUI.style.color = <span class="string">&quot;rgb(255, 51, 51)&quot;</span>; <span class="comment">// red</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (frSenderInfo.status == FrameSenderStatus.WaitingAck) &#123;</span><br><span class="line">                frameUI.style.color = <span class="string">&quot;rgb(255, 236, 139)&quot;</span>; <span class="comment">// yellow</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">this</span>.frameSenderUI.appendChild(frameUI);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">UpdateReceiveBinBufferUI</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="comment">// Update errorArr, drop expired errors</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="built_in">this</span>.errorArr.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.errorArr[i] &lt; <span class="built_in">this</span>.host.processedBitCnt) &#123;</span><br><span class="line">                <span class="built_in">this</span>.errorArr.splice(i, <span class="number">1</span>);</span><br><span class="line">                i--;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> binText = binArray2CubeText(<span class="built_in">this</span>.host.receiveBinBuffer);</span><br><span class="line">        <span class="built_in">this</span>.receiveBinBufferUI.innerHTML = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="comment">// remove all child</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="built_in">this</span>.receiveBinBufferUI.firstChild) &#123;</span><br><span class="line">            <span class="built_in">this</span>.receiveBinBufferUI.removeChild(<span class="built_in">this</span>.receiveBinBufferUI.firstChild);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; binText.length; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.errorArr.indexOf(i + <span class="built_in">this</span>.host.processedBitCnt) == -<span class="number">1</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.receiveBinBufferUI.innerHTML += binText[i];</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// append span child</span></span><br><span class="line">                <span class="keyword">var</span> span = <span class="built_in">document</span>.createElement(<span class="string">&quot;span&quot;</span>);</span><br><span class="line">                span.className = <span class="string">&quot;error&quot;</span>;</span><br><span class="line">                span.innerHTML = binText[i];</span><br><span class="line">                <span class="built_in">this</span>.receiveBinBufferUI.appendChild(span);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">8</span> == <span class="number">7</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.receiveBinBufferUI.innerHTML += <span class="string">&quot; &quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// scroll to bottom</span></span><br><span class="line">        <span class="built_in">this</span>.receiveBinBufferUI.scrollTop = <span class="built_in">this</span>.receiveBinBufferUI.scrollHeight;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.errorArr.length == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.receiveBinBufferUI.style.border = <span class="string">&quot;3px solid green&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.errorArr.length &gt; <span class="number">0</span> &amp;&amp; <span class="built_in">this</span>.errorArr.length &lt; <span class="number">8</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.receiveBinBufferUI.style.border = <span class="string">&quot;3px solid red&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="title">UpdateFrameReceiveBufferUI</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.frameReceiverUI.innerHTML = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="comment">// remove all child</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="built_in">this</span>.frameReceiverUI.firstChild) &#123;</span><br><span class="line">            <span class="built_in">this</span>.frameReceiverUI.removeChild(<span class="built_in">this</span>.frameReceiverUI.firstChild);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="built_in">this</span>.host.receiveFrameBuffer.length; i++) &#123;</span><br><span class="line">            <span class="keyword">var</span> extractedFrame = <span class="built_in">this</span>.host.receiveFrameBuffer[i];</span><br><span class="line">            <span class="keyword">var</span> frameUI = <span class="built_in">document</span>.createElement(<span class="string">&quot;div&quot;</span>);</span><br><span class="line">            frameUI.className = <span class="string">&quot;tempFrame&quot;</span>;</span><br><span class="line">            <span class="keyword">if</span> (extractedFrame == <span class="literal">null</span>) &#123;</span><br><span class="line">                frameUI.innerHTML = <span class="string">&quot;&#123; ----------------------------------- &#125;&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">var</span> dataStr = bytes2str(extractedFrame.data);</span><br><span class="line">                <span class="keyword">if</span> (dataStr.length &gt; <span class="number">25</span>) &#123;</span><br><span class="line">                    dataStr = dataStr.slice(<span class="number">0</span>, <span class="number">25</span>) + <span class="string">&quot;...&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                frameUI.innerHTML = <span class="string">&quot;&#123; &quot;</span> + dataStr + <span class="string">&quot; &#125;&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            frameUI.style.textAlign = <span class="string">&quot;center&quot;</span>;</span><br><span class="line">            frameUI.style.fontSize = <span class="number">5</span> + <span class="string">&quot;px&quot;</span>;</span><br><span class="line">            <span class="built_in">this</span>.frameReceiverUI.appendChild(frameUI);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    </div>
</div>
<p>For <code>index.html</code></p>
<div class='spoiler collapsed'>
    <div class='spoiler-title'>
        index.html
    </div>
    <div class='spoiler-content'>
        <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Selective Repeat ARQ<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- make background black --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-tag">body</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="attribute">background-color</span>: <span class="number">#23252F</span>;</span></span><br><span class="line"><span class="css">            <span class="attribute">color</span>: <span class="number">#AAC5FF</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="css">        <span class="selector-tag">span</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="attribute">color</span>: <span class="built_in">rgb</span>(<span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>);</span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;main&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:80%;margin: 0 auto;&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">center</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;border: 2px dotted #575757;&quot;</span>&gt;</span>Selective Repeat ARQ Simulation<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;https://kyriota.com/2023/01/03/SelectiveRepeatARQ-Simulation/&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;color: #F378BF;&quot;</span>&gt;</span>click here for help and detail<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">center</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;host0&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:50%;float:left;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">center</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;height: 0px;color: yellow;&quot;</span>&gt;</span>User Input<span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">textarea</span> <span class="attr">id</span>=<span class="string">&quot;host0_userInput&quot;</span> <span class="attr">cols</span>=<span class="string">&quot;60&quot;</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">rows</span>=<span class="string">&quot;4&quot;</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">style</span>=<span class="string">&quot;background-color: #191b20;color:white;&quot;</span>&gt;</span>@kyriota My name is kira yoshikake, 33 years old. Living in the villa area northeast of duwangting, unmarried. I work in Guiyou chain store. Every day I have to work overtime until 8 p.m. to go home. I don&#x27;t smoke. The wine is only for a taste. Sleep at 11 p.m. for 8 hours a day. Before I go to bed, I must drink a cup of warm milk, then do 20 minutes of soft exercise, get on the bed, and immediately fall asleep. Never leave fatigue and stress until the next day. Doctors say I&#x27;m normal. JOJO, people&#x27;s ability is limited. I learned one thing from my short life... The more scheming I am, the more I will find that human ability is limited... Unless I surpass human. I&#x27;m going to give up my human identity! JOJO! &quot;I don&#x27;t want violent happiness Instead, there is no deep despair To pursue a plant like life and live a peaceful life is my goal... &quot;<span class="tag">&lt;/<span class="name">textarea</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;host0_sendButton&quot;</span>&gt;</span>Send<span class="tag">&lt;/<span class="name">button</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;height: 0px;color: yellow;&quot;</span>&gt;</span>Frame Sender Buffer<span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;host0_frameSenderBuffer&quot;</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">style</span>=<span class="string">&quot;width:90%;height:68px;border:1px solid white;overflow-y:scroll;text-align: left;padding: 2px;&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;host0_frameSenderBufferLog&quot;</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">style</span>=<span class="string">&quot;width:90%;height:72px;border:1px dotted rgb(63, 63, 63);text-align: left;padding: 2px;overflow-y: auto;font-size: 2px;&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;height: 0px;color: yellow;&quot;</span>&gt;</span>Receive Bin Buffer<span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;host0_receiveBinBuffer&quot;</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">style</span>=<span class="string">&quot;width:90%;height:72px;border:1px solid white;overflow-y:scroll;text-align: left;padding: 2px;&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;host0_receiveBinBufferLog&quot;</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">style</span>=<span class="string">&quot;width:90%;height:72px;border:1px dotted rgb(63, 63, 63);text-align: left;padding: 2px;overflow-y: auto;font-size: 2px;&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;height: 0px;color: yellow;&quot;</span>&gt;</span>Frame Receiver Buffer<span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;host0_frameReceiverBuffer&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:90%;height:40px;text-align: left;padding: 2px;&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;height: 0px;color: yellow;&quot;</span>&gt;</span>Message<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">textarea</span> <span class="attr">id</span>=<span class="string">&quot;host0_message&quot;</span> <span class="attr">cols</span>=<span class="string">&quot;60&quot;</span> <span class="attr">rows</span>=<span class="string">&quot;5&quot;</span> <span class="attr">disabled</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">style</span>=<span class="string">&quot;background-color: #23252F;color:white;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">center</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;host1&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:50%;float:left;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">center</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;height: 0px;color: yellow;&quot;</span>&gt;</span>User Input<span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">textarea</span> <span class="attr">id</span>=<span class="string">&quot;host1_userInput&quot;</span> <span class="attr">cols</span>=<span class="string">&quot;60&quot;</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">rows</span>=<span class="string">&quot;4&quot;</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">style</span>=<span class="string">&quot;background-color: #191b20;color:white;&quot;</span>&gt;</span>@kyriota &quot;When I was in primary school, there were dozens of signatures on my classmates&#x27; graduation album, but I didn&#x27;t have them. My mother had them, my father had them, but I didn&#x27;t. There were tens of thousands of fans of pop stars and movie stars, but I didn&#x27;t have them.&quot; &quot;In my life, it&#x27;s impossible to meet real friends. It&#x27;s impossible for me to connect with people who can&#x27;t see the green emperor.&quot; &quot;It&#x27;s 5:15 in Cairo now. Japan has jet lag. It should be midnight. What are my parents doing? Have you slept? I want you to worry, sorry... &quot; &quot;The last emerald spray... I have... Tried my best... This is me, the last rumor... Mr. josda... Please accept it.&quot; ------Hua Jing Yuan Dian Ming Hua Jing Yuan Dian Ming Death. With a regretless smile on his face, he ended his life at the age of 17<span class="tag">&lt;/<span class="name">textarea</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;host1_sendButton&quot;</span>&gt;</span>Send<span class="tag">&lt;/<span class="name">button</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;height: 0px;color: yellow;&quot;</span>&gt;</span>Frame Sender Buffer<span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;host1_frameSenderBuffer&quot;</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">style</span>=<span class="string">&quot;width:90%;height:68px;border:1px solid white;overflow-y:scroll;text-align: left;padding: 2px;&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;host1_frameSenderBufferLog&quot;</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">style</span>=<span class="string">&quot;width:90%;height:72px;border:1px dotted rgb(63, 63, 63);text-align: left;padding: 2px;overflow-y: auto;font-size: 2px;&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;height: 0px;color: yellow;&quot;</span>&gt;</span>Receive Bin Buffer<span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;host1_receiveBinBuffer&quot;</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">style</span>=<span class="string">&quot;width:90%;height:72px;border:1px solid white;overflow-y:scroll;text-align: left;padding: 2px;&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;host1_receiveBinBufferLog&quot;</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">style</span>=<span class="string">&quot;width:90%;height:72px;border:1px dotted rgb(63, 63, 63);text-align: left;padding: 2px;overflow-y: auto;font-size: 2px;&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;height: 0px;color: yellow;&quot;</span>&gt;</span>Frame Receiver Buffer<span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;host1_frameReceiverBuffer&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:90%;height:40px;text-align: left;padding: 2px;&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;height: 0px;color: yellow;&quot;</span>&gt;</span>Message<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">textarea</span> <span class="attr">id</span>=<span class="string">&quot;host1_message&quot;</span> <span class="attr">cols</span>=<span class="string">&quot;60&quot;</span> <span class="attr">rows</span>=<span class="string">&quot;5&quot;</span> <span class="attr">disabled</span></span></span><br><span class="line"><span class="tag">                    <span class="attr">style</span>=<span class="string">&quot;background-color: #23252F;color:white;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">center</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;ARQ_Simulator.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">        <span class="comment">// resize the receive bin buffer divs when the window is resized</span></span></span><br><span class="line"><span class="javascript">        <span class="function"><span class="keyword">function</span> <span class="title">ResizeUI</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> temp = <span class="number">121</span>;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> base = <span class="built_in">window</span>.innerWidth / <span class="number">3</span>;</span></span><br><span class="line"><span class="javascript">            <span class="comment">// resize all the divs</span></span></span><br><span class="line"><span class="javascript">            <span class="built_in">document</span>.getElementById(<span class="string">&quot;host0_receiveBinBuffer&quot;</span>).style.width = (base - base % temp) + <span class="string">&quot;px&quot;</span>;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">document</span>.getElementById(<span class="string">&quot;host1_receiveBinBuffer&quot;</span>).style.width = (base - base % temp) + <span class="string">&quot;px&quot;</span>;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">document</span>.getElementById(<span class="string">&quot;host0_frameSenderBuffer&quot;</span>).style.width = (base - base % temp) + <span class="string">&quot;px&quot;</span>;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">document</span>.getElementById(<span class="string">&quot;host1_frameSenderBuffer&quot;</span>).style.width = (base - base % temp) + <span class="string">&quot;px&quot;</span>;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">document</span>.getElementById(<span class="string">&quot;host0_frameReceiverBuffer&quot;</span>).style.width = (base - base % temp) + <span class="string">&quot;px&quot;</span>;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">document</span>.getElementById(<span class="string">&quot;host1_frameReceiverBuffer&quot;</span>).style.width = (base - base % temp) + <span class="string">&quot;px&quot;</span>;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">document</span>.getElementById(<span class="string">&quot;host0_frameSenderBufferLog&quot;</span>).style.width = (base - base % temp) + <span class="string">&quot;px&quot;</span>;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">document</span>.getElementById(<span class="string">&quot;host1_frameSenderBufferLog&quot;</span>).style.width = (base - base % temp) + <span class="string">&quot;px&quot;</span>;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">document</span>.getElementById(<span class="string">&quot;host0_receiveBinBufferLog&quot;</span>).style.width = (base - base % temp) + <span class="string">&quot;px&quot;</span>;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">document</span>.getElementById(<span class="string">&quot;host1_receiveBinBufferLog&quot;</span>).style.width = (base - base % temp) + <span class="string">&quot;px&quot;</span>;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">document</span>.getElementById(<span class="string">&quot;host0_userInput&quot;</span>).style.width = (base - base % temp) + <span class="string">&quot;px&quot;</span>;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">document</span>.getElementById(<span class="string">&quot;host1_userInput&quot;</span>).style.width = (base - base % temp) + <span class="string">&quot;px&quot;</span>;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">document</span>.getElementById(<span class="string">&quot;host0_message&quot;</span>).style.width = (base - base % temp) + <span class="string">&quot;px&quot;</span>;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">document</span>.getElementById(<span class="string">&quot;host1_message&quot;</span>).style.width = (base - base % temp) + <span class="string">&quot;px&quot;</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="javascript">        <span class="built_in">window</span>.addEventListener(<span class="string">&quot;resize&quot;</span>, ResizeUI);</span></span><br><span class="line">        ResizeUI();</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

    </div>
</div>
<h2 id="Postscript"><a href="#Postscript" class="headerlink" title="Postscript"></a>Postscript</h2><p>I highly recommend using emoji or something intuitive in your log text when possible, which can increase your reading speed of log text significantly</p>
<link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>
                            </div>

                            <div>
                                <center>
                                    <div class="pagination">

    
    
    <a href="/2023/01/16/攒机小技巧/" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> Prev</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2022/12/12/OnePixelAttackWithDifferentialEvolution/" type="button" class="btn btn-default ">Next<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>

                                </center>
                            </div>

                            <!-- comment -->
                            
<section id="comment">
    <h2 class="title">Comments</h2>

    
</section>


                    </div>
                    <!-- col-md-9/col-md-12 -->

                    
                        <div id="side_meta">
                            <div class="col-md-3" id="post_meta">

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2023-01-03
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/课内/">课内<span>2</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
	

	<!-- toc -->
	<div class="meta-widget">
	
	   <a data-toggle="collapse" data-target="#toc"><i class="fa fa-bars"></i></a>
	   <div id="toc" class="toc collapse in">
		   <span class="toc-title">Contents</span>
			<ol class="toc-article"><li class="toc-article-item toc-article-level-1"><a class="toc-article-link" href="#Selective-Repeat-ARQ-Simulation"><span class="toc-article-text">Selective Repeat ARQ Simulation</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Theory"><span class="toc-article-text">Theory</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Framing"><span class="toc-article-text">Framing</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Window-amp-Control-Frame"><span class="toc-article-text">Window &amp; Control Frame</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Details"><span class="toc-article-text">Details</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#Error-Control"><span class="toc-article-text">Error Control</span></a></li></ol></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Source"><span class="toc-article-text">Source</span></a></li><li class="toc-article-item toc-article-level-2"><a class="toc-article-link" href="#Postscript"><span class="toc-article-text">Postscript</span></a></li></ol></li></ol>
		</div>
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->

                        </div>
                        

            </div>
            <!-- row -->
            


                
                    <div id="gitalk-container"></div>
                    <link rel="stylesheet" href="/css/gitalk.css">
<script src="/js/gitalk.min.js"></script>
<script src="/js/md5.min.js"></script>
<script type="text/javascript">
    new Gitalk({
        clientID: '91155bbf0d150664c4e8',
        clientSecret: 'a6ace36b45921480fe64e5a8d76de241d197bb15',
        repo: 'kyriota.github.io',
        owner: 'Kyriota',
        admin: 'Kyriota',
        id: md5(location.pathname),
        createIssueManually: true,
        distractionFreeMode: true
    }).render('gitalk-container')
</script>
                        
	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
    
        &copy;
        2024
            KYRIOTA
                
                                Powered By <a href="http://hexo.io/" target="_blank">Hexo</a>, Modified From <a target="_blank" rel="noopener" href="http://github.com/wzpan/hexo-theme-freemind/">Freemind.386</a>.
</p> </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
